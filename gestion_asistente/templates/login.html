{% extends 'base.html' %}
{% load static %}

{% block contenido %}
<!-- Anunciador para lectores de pantalla -->
<div aria-live="assertive" aria-atomic="true" id="anunciador" class="sr-only"></div>
<div aria-live="polite" aria-atomic="true" id="anunciador-suave" class="sr-only"></div>

<!-- Control de Voz en Tiempo Real -->
<div class="voz-control-container position-fixed top-0 end-0 m-3" style="z-index: 9999;">
    <div class="card border-0 shadow-lg bg-primary text-white">
        <div class="card-body p-3">
            <div class="d-flex align-items-center mb-2">
                <h2 class="h6 mb-0 me-3">Control de Voz</h2>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="voz-habilitada" checked>
                    <label class="form-check-label text-white" for="voz-habilitada">
                        Activado
                    </label>
                </div>
            </div>
            
            <div class="btn-group w-100 mb-2" role="group" aria-label="Controles de voz">
                <button type="button" 
                        class="btn btn-success btn-sm" 
                        id="btn-escuchar"
                        aria-describedby="ayuda-escuchar">
                    <i class="fas fa-microphone me-1" aria-hidden="true"></i>
                    Escuchar
                </button>
                <button type="button" 
                        class="btn btn-warning btn-sm" 
                        id="btn-parar-voz"
                        aria-describedby="ayuda-parar">
                    <i class="fas fa-stop me-1" aria-hidden="true"></i>
                    Parar
                </button>
                <button type="button" 
                        class="btn btn-info btn-sm" 
                        id="btn-repetir"
                        aria-describedby="ayuda-repetir">
                    <i class="fas fa-redo me-1" aria-hidden="true"></i>
                    Repetir
                </button>
            </div>
            
            <div class="velocidad-voz mb-2">
                <label for="velocidad-voz" class="form-label small text-white">Velocidad:</label>
                <input type="range" 
                       class="form-range" 
                       id="velocidad-voz" 
                       min="0.5" 
                       max="2" 
                       step="0.1" 
                       value="1"
                       aria-describedby="ayuda-velocidad">
            </div>
            
            <div class="selector-voz mb-2">
                <label for="selector-voz" class="form-label small text-white">
                    <i class="fas fa-user-circle me-1"></i>Tipo de Voz:
                </label>
                <select id="selector-voz" class="form-select form-select-sm" aria-label="Seleccionar tipo de voz">
                    <option value="0">üéôÔ∏è Voz Predeterminada</option>
                    <option value="1">üë© Voz Femenina</option>
                    <option value="2">üë® Voz Masculina</option>
                </select>
            </div>
            
            <div class="estado-voz">
                <small class="text-white">
                    <i class="fas fa-circle me-1" id="indicador-voz" aria-hidden="true"></i>
                    <span id="estado-voz-texto">Voz lista</span>
                </small>
            </div>
            
            <!-- Transcript en tiempo real -->
            <div class="transcript-container mt-2 p-2 rounded" style="background-color: rgba(255, 255, 255, 0.1); min-height: 30px;">
                <small class="text-white-50">
                    <i class="fas fa-microphone me-1"></i>Transcript:
                </small>
                <div id="transcript-voz" class="text-white small mt-1" style="min-height: 20px; font-style: italic;">
                    Presiona ESPACIO para hablar...
                </div>
            </div>
            
            <!-- Instrucci√≥n Push-to-Talk -->
            <div class="mt-2 p-2 rounded text-center" style="background-color: rgba(13, 202, 240, 0.2); border: 1px solid rgba(13, 202, 240, 0.4);">
                <small class="text-info">
                    <i class="fas fa-keyboard me-1"></i>
                    <strong>Push-to-Talk:</strong> Mant√©n ESPACIO y habla
                </small>
            </div>
        </div>
    </div>
</div>

<div class="container vh-100 d-flex flex-column align-items-center justify-content-center">
<!-- <h5 class="text-center mb-3"><b>S</b>istema de <b>A</b>dministraci√≥n de <b>R</b>ecursos y <b>A</b>plicaciones</h5>-->
    <div class="card shadow-lg rounded-3 border-0" style="max-width: 400px; width: 100%; animation: fadeIn 0.8s ease-in-out;">
        <div class="card-body p-4 textoI" style="font-family: Lato;">
            
            <!-- Bot√≥n del Asistente de Voz -->
            <div class="d-flex justify-content-end mb-3">
                <button type="button" 
                        class="btn btn-primary btn-sm position-relative"
                        data-bs-toggle="modal" 
                        data-bs-target="#asistente-modal"
                        id="btn-asistente-voz"
                        data-voz="Abrir asistente virtual de voz para ayuda en el inicio de sesi√≥n">
                    <i class="fas fa-robot me-2" aria-hidden="true"></i>
                    <span class="fw-bold">Asistente de Voz</span>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                        üîä
                    </span>
                </button>
            </div>
            
        <form action="" method="POST" id="loginForm">
            {% csrf_token %}
            <div class="text-center mb-3">
                <img src="{% static 'imgs/vocalcart.jpg' %}" 
                alt="Logo de VOCALCART" 
                style="max-width: 150px; height: auto;"
                data-voz="Logo de VOCALCART, tu tienda accesible">
                <p class="text-muted small mt-2" data-voz="Formulario de inicio de sesi√≥n en VOCALCART">Inicia sesi√≥n en VOCALCART</p>
            </div>
            
            <!-- Instrucciones de accesibilidad -->
            <div class="alert alert-info small mb-3" role="alert" data-voz="Instrucciones: Mant√©n Espacio para hablar, Tab para navegar entre campos, Alt V para activar o desactivar voz, Alt A para abrir asistente">
                üîä <strong>Accesibilidad:</strong> 
                <kbd>ESPACIO</kbd> para hablar | 
                <kbd>Tab</kbd> navegar | 
                <kbd>Alt+V</kbd> voz | 
                <kbd>Alt+A</kbd> asistente
            </div>
            
            <div class="form-floating mb-3">
                <input type="text" 
                       class="form-control" 
                       name="username" 
                       id="username" 
                       placeholder="Usuario" 
                       required
                       data-voz="Campo nombre de usuario. El asistente de voz puede ayudarte a llenar este campo"
                       aria-describedby="ayuda-username">
                <label for="username">
                    <i class="fas fa-user me-2"></i>Usuario
                </label>
                <div id="ayuda-username" class="form-text">
                    El asistente de voz puede ayudarte a llenar este campo
                </div>
            </div>
            <div class="form-floating mb-3">
                <input type="password" 
                       class="form-control" 
                       name="password" 
                       id="password" 
                       placeholder="Contrase√±a" 
                       required
                       data-voz="Campo contrase√±a. Puedes usar el comando de voz: mi contrase√±a es, seguido de tu contrase√±a"
                       aria-describedby="ayuda-password">
                <label for="password">
                    <i class="fas fa-lock me-2"></i>Contrase√±a
                </label>
                <div id="ayuda-password" class="form-text">
                    üé§ Di "mi contrase√±a es..." para llenar con voz
                </div>
            </div>
            <div class="d-grid gap-2 mb-3">
                <button type="submit" 
                        class="btn btn-success btn-lg" 
                        name="login" 
                        id="submitBtn"
                        style="font-family: Lato;"
                        data-voz="Bot√≥n iniciar sesi√≥n. Al presionar este bot√≥n iniciar√°s sesi√≥n en VOCALCART">
                    <i class="fas fa-sign-in-alt me-2"></i> Iniciar sesi√≥n
                </button>
            </div>
            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                        {% if message.tags == 'error' %}
                            <i class="fas fa-exclamation-triangle me-2"></i>
                        {% elif message.tags == 'success' %}
                            <i class="fas fa-check-circle me-2"></i>
                        {% else %}
                            <i class="fas fa-info-circle me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
            <div class="text-center">

                <div class="row">
                    <div class="col">
                    </div>

                    <a href="{% url 'registrarse' %}" class="text-success text-decoration-none fw-bold">
                        <i class="fas fa-user-plus me-1"></i>Crear cuenta
                    </a>
                  
                </div>

    
            </div>

        </form>
        </div>
    </div> 
    
    <div class="text-center mt-3" style="color: white;">
        UNEMI - VOCALCART &copy V0.0
    </div>
</div>

<!-- Modal de Asistente de Voz -->
<div class="modal fade" id="asistente-modal" tabindex="-1" aria-labelledby="asistente-modal-title" aria-describedby="asistente-modal-descripcion">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h2 class="modal-title h4" id="asistente-modal-title" data-voz="Asistente virtual de voz para ayuda en el inicio de sesi√≥n">
                    <i class="fas fa-robot me-3" aria-hidden="true"></i>
                    üîä Asistente de Voz - Inicio de Sesi√≥n
                </h2>
                <button type="button" 
                        class="btn-close btn-close-white" 
                        data-bs-dismiss="modal" 
                        aria-label="Cerrar asistente virtual"
                        data-voz="Cerrar asistente virtual"></button>
            </div>
            <div class="modal-body">
                <div id="asistente-modal-descripcion" class="mb-4">
                    <div class="alert alert-info" data-voz="Bienvenido al asistente de voz para inicio de sesi√≥n. Puedo ayudarte a llenar el formulario">
                        <h3 class="h5 mb-2">üéØ ¬°Bienvenido al Asistente de Inicio de Sesi√≥n!</h3>
                        <p class="mb-2">Soy tu asistente especializado para personas con discapacidad visual. Puedo:</p>
                        <ul class="mb-2">
                            <li>üó£Ô∏è Leer los campos del formulario</li>
                            <li>‚úçÔ∏è Ayudarte a llenar el nombre de usuario con voz</li>
                            <li>üìù Explicar el proceso de inicio de sesi√≥n</li>
                            <li>üîí Indicarte cu√°ndo debes ingresar tu contrase√±a</li>
                            <li>‚úÖ Guiarte en el proceso de acceso</li>
                        </ul>
                        <p class="mb-0 text-danger"><strong>‚ö†Ô∏è Importante:</strong> Por seguridad, el campo de contrase√±a NO usa el asistente de voz y debe ser llenado manualmente.</p>
                    </div>
                </div>
                
                <!-- Controles de voz del asistente -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h4 class="h6 mb-3" data-voz="Comandos de voz disponibles para el inicio de sesi√≥n">üé§ Comandos de Voz:</h4>
                                
                                <!-- Instrucci√≥n Push-to-Talk destacada -->
                                <div class="alert alert-primary mb-3" role="alert">
                                    <strong><i class="fas fa-keyboard me-1"></i>Push-to-Talk:</strong>
                                    <br>Mant√©n presionada la tecla <kbd>ESPACIO</kbd> y habla
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-sm text-start" onclick="hablarTexto('Di: mi usuario es, seguido de tu nombre de usuario. Por ejemplo: mi usuario es danny')">
                                        "mi usuario es [nombre]"
                                    </button>
                                    <button class="btn btn-success btn-sm text-start" onclick="hablarTexto('Di: mi contrase√±a es, seguido de tu contrase√±a. Por ejemplo: mi contrase√±a es mi clave secreta')">
                                        "mi contrase√±a es [clave]"
                                    </button>
                                    <button class="btn btn-success btn-sm text-start" onclick="hablarTexto('Di: iniciar sesi√≥n, para enviar el formulario')">
                                        "iniciar sesi√≥n"
                                    </button>
                                    <button class="btn btn-primary btn-sm text-start" onclick="hablarTexto('Di: crear cuenta, para ir a la p√°gina de registro')">
                                        <i class="fas fa-user-plus me-1"></i>"crear cuenta"
                                    </button>
                                    <button class="btn btn-warning btn-sm text-start" onclick="hablarTexto('Di: limpiar, para borrar todos los campos')">
                                        "limpiar"
                                    </button>
                                    <button class="btn btn-info btn-sm text-start" onclick="leerCamposFormulario()">
                                        "leer campos"
                                    </button>
                                    <button class="btn btn-secondary btn-sm text-start" onclick="hablarTexto('Di: ayuda, para obtener informaci√≥n sobre los comandos disponibles')">
                                        "ayuda"
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h4 class="h6 mb-3" data-voz="Estado del reconocimiento de voz">üéØ Estado de Voz:</h4>
                                <div id="reconocimiento-estado" class="mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="status-indicator me-2" id="status-voz"></div>
                                        <span id="status-texto">Voz lista</span>
                                    </div>
                                    <button class="btn btn-primary w-100" id="btn-iniciar-reconocimiento" onclick="iniciarReconocimientoVoz()">
                                        <i class="fas fa-microphone me-2"></i>
                                        Iniciar Reconocimiento de Voz
                                    </button>
                                </div>
                                <div class="small text-muted">
                                    üí° Di comandos como: "mi usuario es..." para llenar el campo de usuario
                                </div>
                                
                                <!-- Bot√≥n de ayuda para permisos -->
                                <div class="mt-3">
                                    <button class="btn btn-outline-info btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#ayudaPermisos" aria-expanded="false">
                                        <i class="fas fa-question-circle me-2"></i>
                                        ¬øProblemas con el micr√≥fono?
                                    </button>
                                    <div class="collapse mt-2" id="ayudaPermisos">
                                        <div class="card card-body bg-info bg-opacity-10">
                                            <h6 class="text-info mb-2">
                                                <i class="fas fa-info-circle me-2"></i>
                                                C√≥mo habilitar el micr√≥fono:
                                            </h6>
                                            <ol class="small mb-0 ps-3">
                                                <li class="mb-2">
                                                    <strong>Chrome/Edge:</strong> Haz clic en el icono de candado üîí en la barra de direcciones
                                                </li>
                                                <li class="mb-2">
                                                    <strong>Selecciona:</strong> "Permisos del sitio" o "Configuraci√≥n del sitio"
                                                </li>
                                                <li class="mb-2">
                                                    <strong>Micr√≥fono:</strong> Cambia de "Bloqueado" a "Permitir"
                                                </li>
                                                <li class="mb-0">
                                                    <strong>Recarga:</strong> Actualiza la p√°gina y prueba de nuevo
                                                </li>
                                            </ol>
                                            <div class="alert alert-warning small mb-0 mt-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                <strong>Nota:</strong> Firefox tiene soporte limitado. Usa Chrome o Edge para mejor experiencia.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat del asistente -->
                <div class="chat-container">
                    <div class="chat-messages border rounded p-3 mb-3" 
                         id="chat-messages" 
                         role="log" 
                         aria-live="polite" 
                         aria-label="Conversaci√≥n con el asistente"
                         style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                        
                        <div class="message asistente-message mb-3">
                            <div class="d-flex align-items-start">
                                <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-robot" aria-hidden="true"></i>
                                </div>
                                <div class="message-content">
                                    <strong>Asistente de Voz:</strong>
                                    <p class="mb-2">¬°Hola! Soy tu asistente para el inicio de sesi√≥n en VOCALCART. Estoy aqu√≠ para ayudarte a acceder a tu cuenta de forma accesible.</p>
                                    <div class="small text-muted">
                                        üí° <strong>Tip:</strong> Puedes usar comandos de voz o escribir. Di "ayuda" para m√°s opciones.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input para chat -->
                    <div class="input-group">
                        <label for="chat-input" class="sr-only">Escribir mensaje al asistente</label>
                        <input type="text" 
                               id="chat-input" 
                               class="form-control form-control-lg" 
                               placeholder="Escribe tu pregunta o usa comandos de voz..." 
                               aria-describedby="ayuda-chat">
                        <button type="button" 
                                class="btn btn-primary" 
                                onclick="enviarMensajeConVoz()"
                                aria-label="Enviar mensaje">
                            <i class="fas fa-paper-plane" aria-hidden="true"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-success" 
                                onclick="activarEscuchaDirecta()"
                                aria-label="Activar micr√≥fono">
                            <i class="fas fa-microphone" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div id="ayuda-chat" class="form-text">
                        Presiona Enter para enviar o usa el micr√≥fono para hablar directamente
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-voz="Cerrar asistente">
                    <i class="fas fa-times me-2" aria-hidden="true"></i>
                    Cerrar
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="limpiarChatConVoz()" data-voz="Iniciar nueva conversaci√≥n">
                    <i class="fas fa-refresh me-2" aria-hidden="true"></i>
                    Nueva Conversaci√≥n
                </button>
                <button type="button" class="btn btn-info" onclick="iniciarLoginPorVoz()" data-voz="Iniciar proceso de inicio de sesi√≥n completamente por voz">
                    <i class="fas fa-microphone-alt me-2" aria-hidden="true"></i>
                    üéôÔ∏è Iniciar Sesi√≥n por Voz
                </button>
                <button type="button" class="btn btn-success" onclick="leerCamposFormulario()" data-voz="Leer todos los campos del formulario">
                    <i class="fas fa-volume-up me-2" aria-hidden="true"></i>
                    Leer Formulario
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales para funcionalidad de voz
let vozHabilitada = true;
let reconocimientoVoz = null;
let vozActual = null;
let vocesDisponibles = [];
let velocidadVoz = 1;
let ultimoTextoHablado = '';
let escuchandoComandos = false;

// Variables para Vosk WebSocket (reconocimiento offline - MISMO QUE REACT)
let voskWebSocket = null;
let audioContext = null;
let mediaStream = null;
let audioProcessor = null;
let isPushToTalkActive = false;
let ultimoComandoProcesado = '';  // NUEVO: Para evitar duplicados
let tiempoUltimoComando = 0;      // NUEVO: Timestamp del √∫ltimo comando

// Variables para el flujo de inicio de sesi√≥n por voz
let modoLoginPorVoz = false;
let datosLoginVoz = {
    username: '',
    password: ''
};
let pasoActualLogin = 0;

// Inicializaci√≥n de funciones de voz
document.addEventListener('DOMContentLoaded', function() {
    inicializarVoz();
    configurarAtajosTeclado();
    configurarEventosVoz();
    configurarCamposConVoz();
    
    // Anunciar carga de p√°gina despu√©s de un delay
    setTimeout(() => {
        if (vozHabilitada) {
            hablarTexto('Bienvenido a VOCALCART, tienda accesible. P√°gina de inicio de sesi√≥n cargada. Si no tienes cuenta, di: crear cuenta. Si ya tienes cuenta, presiona ESPACIO y di: mi usuario es, seguido de tu nombre.');
        }
    }, 1500);
});

// Inicializar s√≠ntesis de voz Y reconocimiento Vosk
function inicializarVoz() {
    if ('speechSynthesis' in window) {
        // Configurar voces en espa√±ol
        function cargarVoces() {
            vocesDisponibles = speechSynthesis.getVoices();
            const vocesEspanol = vocesDisponibles.filter(voz => voz.lang.startsWith('es'));
            
            if (vocesEspanol.length > 0) {
                // Intentar encontrar diferentes tipos de voces
                const vozFemenina = vocesEspanol.find(voz => 
                    voz.name.toLowerCase().includes('female') || 
                    voz.name.toLowerCase().includes('femenina') ||
                    voz.name.toLowerCase().includes('woman') ||
                    voz.name.toLowerCase().includes('zira') ||
                    voz.name.toLowerCase().includes('helena') ||
                    voz.name.toLowerCase().includes('monica')
                );
                
                const vozMasculina = vocesEspanol.find(voz => 
                    voz.name.toLowerCase().includes('male') || 
                    voz.name.toLowerCase().includes('masculina') ||
                    voz.name.toLowerCase().includes('man') ||
                    voz.name.toLowerCase().includes('diego') ||
                    voz.name.toLowerCase().includes('jorge')
                );
                
                // Configurar array de voces disponibles
                vocesDisponibles = [
                    vocesEspanol[0], // Voz predeterminada
                    vozFemenina || vocesEspanol[1] || vocesEspanol[0], // Voz femenina
                    vozMasculina || vocesEspanol[2] || vocesEspanol[0]  // Voz masculina
                ];
                
                vozActual = vocesDisponibles[0]; // Establecer la primera por defecto
                
                console.log('Voces cargadas:', vocesDisponibles.map(v => v.name));
            }
        }
        
        // Cargar voces
        cargarVoces();
        speechSynthesis.onvoiceschanged = cargarVoces;
        
        // ========== NUEVO: Conectar a Vosk WebSocket (IGUAL QUE REACT) ==========
        conectarVoskWebSocket();
        
        // Inicializar captura de audio
        inicializarCapturaAudio();
        
    } else {
        console.warn('S√≠ntesis de voz no soportada en este navegador');
    }
}

// ========== FUNCIONES VOSK WEBSOCKET (COPIADAS DE REACT) ==========

function conectarVoskWebSocket() {
    try {
        voskWebSocket = new WebSocket('ws://localhost:8000/ws/voice/');

        voskWebSocket.onopen = () => {
            console.log('‚úÖ WebSocket Vosk conectado - Reconocimiento offline listo');
            actualizarEstadoVoz('Presiona ESPACIO para hablar');
            const transcriptElement = document.getElementById('transcript-voz');
            if (transcriptElement) {
                transcriptElement.textContent = 'Presiona ESPACIO para hablar...';
                transcriptElement.style.color = '#10b981';
            }
        };

        voskWebSocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const transcriptElement = document.getElementById('transcript-voz');
            
            switch(data.type) {
                case 'ready':
                    console.log('üé§ Vosk listo:', data.message);
                    break;
                
                case 'partial':
                    console.log('üéôÔ∏è Parcial:', data.transcript);
                    if (transcriptElement) {
                        transcriptElement.textContent = data.transcript;
                        transcriptElement.style.fontWeight = 'normal';
                        transcriptElement.style.color = '#0dcaf0';
                    }
                    
                    // NUEVO: Procesar comandos en tiempo real desde partial
                    const comandoParcial = data.transcript.toLowerCase().trim();
                    if (comandoParcial.includes('mi usuario es') || 
                        comandoParcial.includes('mi contrase√±a es') ||
                        comandoParcial.includes('mi clave es')) {
                        // Si detectamos un comando completo en partial, procesarlo inmediatamente
                        procesarComandoVozLogin(comandoParcial);
                    }
                    break;
                
                case 'result':
                case 'final':
                    console.log('‚úÖ Final:', data.transcript);
                    if (transcriptElement) {
                        transcriptElement.textContent = `‚úì ${data.transcript}`;
                        transcriptElement.style.fontWeight = 'bold';
                        transcriptElement.style.color = '#10b981';
                    }
                    
                    // Procesar el comando final (por si no se proces√≥ en partial)
                    procesarComandoVozLogin(data.transcript.toLowerCase().trim());
                    
                    // Limpiar transcript despu√©s de 2 segundos (reducido de 3)
                    setTimeout(() => {
                        if (transcriptElement) {
                            transcriptElement.textContent = 'Presiona ESPACIO para hablar...';
                            transcriptElement.style.color = '#6c757d';
                        }
                    }, 2000);
                    break;
                
                case 'error':
                    console.error('‚ùå Error Vosk:', data.message);
                    actualizarEstadoVoz(`Error: ${data.message}`);
                    if (transcriptElement) {
                        transcriptElement.textContent = `‚ùå Error: ${data.message}`;
                        transcriptElement.style.color = '#ff6b6b';
                    }
                    break;
            }
        };

        voskWebSocket.onerror = (error) => {
            console.error('‚ùå Error WebSocket:', error);
            actualizarEstadoVoz('Error de conexi√≥n');
            const transcriptElement = document.getElementById('transcript-voz');
            if (transcriptElement) {
                transcriptElement.textContent = '‚ùå Error de conexi√≥n con servidor Vosk';
                transcriptElement.style.color = '#ff6b6b';
            }
        };

        voskWebSocket.onclose = () => {
            console.log('üîå WebSocket desconectado - Intentando reconectar...');
            actualizarEstadoVoz('Reconectando...');
            setTimeout(conectarVoskWebSocket, 3000);
        };

    } catch (error) {
        console.error('‚ùå Error al conectar WebSocket:', error);
    }
}

async function inicializarCapturaAudio() {
    try {
        console.log('üé§ Solicitando permisos de micr√≥fono...');
        mediaStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                channelCount: 1,
                sampleRate: 16000,
                echoCancellation: true,
                noiseSuppression: true,
            } 
        });
        
        console.log('‚úÖ Permisos de micr√≥fono concedidos');
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 16000
        });

        const source = audioContext.createMediaStreamSource(mediaStream);
        audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);
        
        audioProcessor.onaudioprocess = (e) => {
            if (!isPushToTalkActive || !voskWebSocket || voskWebSocket.readyState !== WebSocket.OPEN) {
                return;
            }

            const audioData = e.inputBuffer.getChannelData(0);
            const pcmData = new Int16Array(audioData.length);
            
            for (let i = 0; i < audioData.length; i++) {
                pcmData[i] = Math.max(-1, Math.min(1, audioData[i])) * 0x7FFF;
            }
            
            voskWebSocket.send(pcmData.buffer);
        };
        
        source.connect(audioProcessor);
        audioProcessor.connect(audioContext.destination);
        
        console.log('‚úÖ Captura de audio inicializada');
        hablarTexto('Sistema de reconocimiento de voz listo. Mant√©n presionada la barra espaciadora para hablar.');
        
    } catch (error) {
        console.error('‚ùå Error al inicializar audio:', error);
        hablarTexto('No se pudo acceder al micr√≥fono. Verifica los permisos en tu navegador.');
        actualizarEstadoVoz('Error: Sin acceso al micr√≥fono');
    }
}

// ========== FIN FUNCIONES VOSK ==========

// Funci√≥n principal para hablar texto
function hablarTexto(texto, interrumpir = true) {
    if (!vozHabilitada || !texto) return;
    
    if (interrumpir) {
        speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(texto);
    utterance.lang = 'es-ES';
    utterance.rate = velocidadVoz;
    utterance.pitch = 1;
    utterance.volume = 1;
    
    if (vozActual) {
        utterance.voice = vozActual;
    }
    
    ultimoTextoHablado = texto;
    
    utterance.onstart = function() {
        document.getElementById('indicador-voz').className = 'fas fa-circle text-success';
        document.getElementById('estado-voz-texto').textContent = 'Hablando...';
    };
    
    utterance.onend = function() {
        document.getElementById('indicador-voz').className = 'fas fa-circle text-secondary';
        document.getElementById('estado-voz-texto').textContent = 'Voz lista';
    };
    
    speechSynthesis.speak(utterance);
    
    // Anunciar en regi√≥n ARIA
    const anunciador = document.getElementById('anunciador');
    if (anunciador) {
        anunciador.textContent = texto;
        setTimeout(() => anunciador.textContent = '', 100);
    }
}

// Configurar atajos de teclado
function configurarAtajosTeclado() {
    let spacebarPressed = false;
    
    document.addEventListener('keydown', function(e) {
        // Push-to-Talk: Spacebar para activar reconocimiento VOSK
        if (e.code === 'Space' && !e.repeat && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            if (!spacebarPressed && vozHabilitada) {
                spacebarPressed = true;
                isPushToTalkActive = true; // Activar bandera para Vosk
                actualizarEstadoVoz('üéôÔ∏è Escuchando...');
                console.log('üé§ Push-to-Talk ACTIVADO');
                
                const transcriptElement = document.getElementById('transcript-voz');
                if (transcriptElement) {
                    transcriptElement.textContent = 'üéôÔ∏è Escuchando...';
                    transcriptElement.style.color = '#0dcaf0';
                }
                
                // Enviar se√±al de inicio al reconocedor para reiniciarlo
                if (voskWebSocket && voskWebSocket.readyState === WebSocket.OPEN) {
                    console.log('üöÄ Enviando se√±al de inicio a Vosk');
                    voskWebSocket.send(JSON.stringify({ type: 'start' }));
                }
            }
        }
        
        // Alt + V: Activar/Desactivar voz
        if (e.altKey && e.key === 'v') {
            e.preventDefault();
            toggleVoz();
        }
        
        // Alt + A: Abrir asistente
        if (e.altKey && e.key === 'a') {
            e.preventDefault();
            document.getElementById('btn-asistente-voz').click();
        }
        
        // Escape: Parar voz
        if (e.key === 'Escape') {
            speechSynthesis.cancel();
        }
        
        // Enter en chat
        if (e.key === 'Enter' && e.target.id === 'chat-input') {
            e.preventDefault();
            enviarMensajeConVoz();
        }
    });
    
    document.addEventListener('keyup', function(e) {
        // Push-to-Talk: Soltar spacebar para detener reconocimiento VOSK
        if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            if (spacebarPressed) {
                spacebarPressed = false;
                isPushToTalkActive = false; // Desactivar bandera para Vosk
                actualizarEstadoVoz('Voz lista');
                console.log('üé§ Push-to-Talk DESACTIVADO');
                
                // Enviar comando final para procesar
                if (voskWebSocket && voskWebSocket.readyState === WebSocket.OPEN) {
                    console.log('üì§ Enviando se√±al de finalizaci√≥n a Vosk');
                    voskWebSocket.send(JSON.stringify({ type: 'stop' }));
                }
            }
        }
    });
}

// Configurar eventos espec√≠ficos de voz
function configurarEventosVoz() {
    // Toggle de voz
    document.getElementById('voz-habilitada').addEventListener('change', function() {
        vozHabilitada = this.checked;
        if (vozHabilitada) {
            hablarTexto('Voz activada');
        } else {
            speechSynthesis.cancel();
        }
    });
    
    // Control de velocidad
    document.getElementById('velocidad-voz').addEventListener('input', function() {
        velocidadVoz = parseFloat(this.value);
        hablarTexto(`Velocidad cambiada a ${Math.round(velocidadVoz * 100)} por ciento`, true);
    });
    
    // Selector de voz
    document.getElementById('selector-voz').addEventListener('change', function() {
        const indiceVoz = parseInt(this.value);
        if (vocesDisponibles[indiceVoz]) {
            vozActual = vocesDisponibles[indiceVoz];
            const tipoVoz = this.options[this.selectedIndex].text;
            hablarTexto(`Voz cambiada a ${tipoVoz}. Esta es una prueba de la nueva voz.`);
        }
    });
    
    // Botones de control
    document.getElementById('btn-escuchar').addEventListener('click', iniciarReconocimientoVoz);
    document.getElementById('btn-parar-voz').addEventListener('click', function() {
        speechSynthesis.cancel();
        if (reconocimientoVoz && escuchandoComandos) {
            reconocimientoVoz.stop();
        }
        hablarTexto('Voz detenida');
    });
    document.getElementById('btn-repetir').addEventListener('click', function() {
        if (ultimoTextoHablado) {
            hablarTexto(ultimoTextoHablado);
        }
    });
}

// Configurar campos del formulario con retroalimentaci√≥n de voz
function configurarCamposConVoz() {
    // Agregar eventos de focus a todos los campos con data-voz
    document.querySelectorAll('[data-voz]').forEach(elemento => {
        elemento.addEventListener('focus', function() {
            const textoVoz = this.getAttribute('data-voz');
            if (textoVoz && vozHabilitada) {
                hablarTexto(textoVoz);
            }
        });
    });
    
    // Evento espec√≠fico para campo de usuario
    const campoUsuario = document.getElementById('username');
    if (campoUsuario) {
        campoUsuario.addEventListener('blur', function() {
            if (this.value && vozHabilitada) {
                hablarTexto(`Nombre de usuario ingresado: ${this.value}`);
            }
        });
    }
}

// Procesar comandos de voz espec√≠ficos para login
function procesarComandoVozLogin(comando) {
    console.log('üé§ Comando recibido:', comando);
    
    // NUEVO: Evitar procesar el mismo comando m√∫ltiples veces
    const ahora = Date.now();
    if (comando === ultimoComandoProcesado && (ahora - tiempoUltimoComando) < 1000) {
        console.log('‚è≠Ô∏è Comando duplicado, ignorando...');
        return;
    }
    
    // Actualizar control de duplicados
    ultimoComandoProcesado = comando;
    tiempoUltimoComando = ahora;
    
    // Si estamos en modo login por voz, procesar el flujo
    if (modoLoginPorVoz) {
        procesarFlujoLoginPorVoz(comando);
        return;
    }
    
    // ========== DETECCI√ìN MEJORADA Y R√ÅPIDA ==========
    
    // Comando para nombre de usuario (con m√∫ltiples variantes)
    if (comando.includes('mi usuario es') || 
        comando.includes('mi nombre de usuario es') || 
        comando.includes('usuario es') ||
        comando.includes('mi usuario') ||
        comando.includes('el usuario es')) {
        
        console.log('üéØ Detectado comando de USUARIO');
        
        // Patrones ordenados de M√ÅS ESPEC√çFICO a MENOS ESPEC√çFICO
        const patrones = [
            'mi nombre de usuario es',
            'el usuario es',
            'mi usuario es',
            'usuario es',
            'mi usuario'
        ];
        const valorExtraido = extraerValorComando(comando, patrones);
        
        console.log('üìù Valor extra√≠do para usuario:', valorExtraido);
        
        if (valorExtraido) {
            document.getElementById('username').value = valorExtraido;
            console.log('‚úÖ Usuario establecido en el campo:', valorExtraido);
            
            // Feedback inmediato
            hablarTexto(`Usuario ${valorExtraido}`);
            
            // Actualizar UI
            const usernameField = document.getElementById('username');
            usernameField.style.borderColor = '#10b981';
            usernameField.style.borderWidth = '2px';
            setTimeout(() => {
                usernameField.style.borderColor = '';
                usernameField.style.borderWidth = '';
            }, 2000);
            
            agregarMensajeChat('Usuario', comando);
            agregarMensajeChat('Asistente', `‚úÖ Usuario: "${valorExtraido}"`);
        } else {
            console.log('‚ö†Ô∏è No se pudo extraer el valor del usuario');
        }
        return;
    }
    
    // Comando para contrase√±a (con m√∫ltiples variantes)
    if (comando.includes('mi contrase√±a es') || 
        comando.includes('mi clave es') || 
        comando.includes('contrase√±a es') ||
        comando.includes('mi contrase√±a') ||
        comando.includes('la contrase√±a es') ||
        comando.includes('password es')) {
        
        console.log('üéØ Detectado comando de CONTRASE√ëA');
        
        // Patrones ordenados de M√ÅS ESPEC√çFICO a MENOS ESPEC√çFICO
        const patrones = [
            'la contrase√±a es',
            'mi contrase√±a es',
            'mi clave es',
            'contrase√±a es',
            'password es',
            'mi contrase√±a',
            'mi clave'
        ];
        const valorExtraido = extraerValorComando(comando, patrones);
        
        console.log('üìù Valor extra√≠do para contrase√±a:', valorExtraido ? '****' : 'null');
        
        if (valorExtraido) {
            document.getElementById('password').value = valorExtraido;
            console.log('‚úÖ Contrase√±a establecida en el campo');
            
            // Feedback inmediato (sin revelar la contrase√±a)
            hablarTexto('Contrase√±a ingresada');
            
            // Actualizar UI
            const passwordField = document.getElementById('password');
            passwordField.style.borderColor = '#10b981';
            passwordField.style.borderWidth = '2px';
            setTimeout(() => {
                passwordField.style.borderColor = '';
                passwordField.style.borderWidth = '';
            }, 2000);
            
            agregarMensajeChat('Usuario', 'mi contrase√±a es ****');
            agregarMensajeChat('Asistente', '‚úÖ Contrase√±a establecida');
            
            // NUEVO: Auto-submit si ambos campos est√°n llenos
            setTimeout(() => {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (username && password) {
                    console.log('üöÄ Ambos campos completos - Iniciando sesi√≥n autom√°ticamente...');
                    hablarTexto('Iniciando sesi√≥n');
                    setTimeout(() => {
                        document.getElementById('loginForm').submit();
                    }, 800);
                }
            }, 500);
        } else {
            console.log('‚ö†Ô∏è No se pudo extraer el valor de la contrase√±a');
        }
        return;
    }
    
    // Comando para iniciar sesi√≥n
    if (comando.includes('iniciar sesi√≥n') || 
        comando.includes('entrar') || 
        comando.includes('login') ||
        comando.includes('ingresar') ||
        comando.includes('iniciar')) {
        
        console.log('üéØ Detectado comando INICIAR SESI√ìN');
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            console.log('‚ö†Ô∏è Faltan datos - Usuario:', username ? 'OK' : 'VAC√çO', 'Password:', password ? 'OK' : 'VAC√çO');
            hablarTexto('Falta informaci√≥n. Necesito usuario y contrase√±a.');
            return;
        }
        
        console.log('üöÄ Enviando formulario de login...');
        hablarTexto('Iniciando sesi√≥n');
        setTimeout(() => {
            document.getElementById('loginForm').submit();
        }, 800);
        return;
    }
    
    // Comando para limpiar campos
    if (comando.includes('limpiar') || 
        comando.includes('borrar') || 
        comando.includes('resetear') ||
        comando.includes('limpiar campos')) {
        
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        hablarTexto('Campos limpiados');
        agregarMensajeChat('Usuario', comando);
        agregarMensajeChat('Asistente', 'üóëÔ∏è Campos limpiados');
        return;
    }
    
    // ========== NUEVO: Comandos para crear cuenta ==========
    if (comando.includes('crear cuenta') || 
        comando.includes('registrarse') || 
        comando.includes('registro') ||
        comando.includes('nueva cuenta') ||
        comando.includes('no tengo cuenta')) {
        
        hablarTexto('Te llevar√© a la p√°gina de registro para crear tu cuenta.');
        setTimeout(() => {
            window.location.href = '/registro/';
        }, 1500);
        return;
    }
    
    // Comando para iniciar login por voz guiado
    if (comando.includes('iniciar sesi√≥n por voz') || 
        comando.includes('login por voz') || 
        comando.includes('entrar por voz') ||
        comando.includes('sesi√≥n guiada')) {
        iniciarLoginPorVoz();
        return;
    }
    
    // Comandos informativos
    if (comando.includes('ayuda') || comando.includes('c√≥mo') || comando.includes('como')) {
        leerCamposFormulario();
        return;
    }
    
    if (comando.includes('leer') || comando.includes('campos')) {
        leerCamposFormulario();
        return;
    }
    
    // Si no reconoci√≥ el comando
    console.log('‚ö†Ô∏è Comando no reconocido:', comando);
}

// Iniciar el proceso de login completamente por voz
function iniciarLoginPorVoz() {
    modoLoginPorVoz = true;
    pasoActualLogin = 0;
    datosLoginVoz = { username: '', password: '' };
    
    const mensaje = 'üéôÔ∏è ¬°Perfecto! Vamos a iniciar sesi√≥n usando solo tu voz. Te guiar√© paso a paso. Primero, dime tu nombre de usuario. Por ejemplo: juan123';
    hablarTexto(mensaje);
    agregarMensajeChat('Asistente', mensaje);
    
    // Activar reconocimiento de voz autom√°ticamente
    if (reconocimientoVoz && !escuchandoComandos) {
        setTimeout(() => {
            reconocimientoVoz.start();
        }, 3000);
    }
}

// Procesar el flujo guiado de login por voz
function procesarFlujoLoginPorVoz(comando) {
    switch(pasoActualLogin) {
        case 0: // Esperando nombre de usuario
            if (comando.length > 2) {
                datosLoginVoz.username = comando.trim();
                document.getElementById('username').value = datosLoginVoz.username;
                
                const mensaje = `‚úÖ Perfecto, usuario "${datosLoginVoz.username}" registrado. Ahora, dime tu contrase√±a. Habla con claridad.`;
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', `Usuario: ${comando}`);
                agregarMensajeChat('Asistente', mensaje);
                
                pasoActualLogin = 1;
            } else {
                hablarTexto('No escuch√© bien tu nombre de usuario. Por favor, rep√≠telo con claridad.');
            }
            break;
            
        case 1: // Esperando contrase√±a
            if (comando.length > 2) {
                datosLoginVoz.password = comando.trim();
                document.getElementById('password').value = datosLoginVoz.password;
                
                const mensaje = `‚úÖ Contrase√±a recibida. ¬øQuieres iniciar sesi√≥n ahora? Di "s√≠" para confirmar o "no" para cancelar.`;
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', 'Contrase√±a: [oculta por seguridad]');
                agregarMensajeChat('Asistente', mensaje);
                
                pasoActualLogin = 2;
            } else {
                hablarTexto('No escuch√© bien tu contrase√±a. Por favor, rep√≠tela con claridad.');
            }
            break;
            
        case 2: // Confirmaci√≥n
            if (comando.includes('s√≠') || comando.includes('si') || comando.includes('confirmar') || comando.includes('aceptar')) {
                const mensaje = 'üéâ ¬°Excelente! Iniciando sesi√≥n...';
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', 'S√≠, confirmar');
                agregarMensajeChat('Asistente', mensaje);
                
                // Detener reconocimiento de voz
                if (reconocimientoVoz && escuchandoComandos) {
                    reconocimientoVoz.stop();
                }
                
                // Enviar formulario
                setTimeout(() => {
                    document.getElementById('loginForm').submit();
                }, 1500);
                
                modoLoginPorVoz = false;
            } else if (comando.includes('no') || comando.includes('cancelar')) {
                const mensaje = 'Inicio de sesi√≥n por voz cancelado. Puedes intentarlo de nuevo cuando quieras.';
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', 'No, cancelar');
                agregarMensajeChat('Asistente', mensaje);
                
                modoLoginPorVoz = false;
                pasoActualLogin = 0;
                datosLoginVoz = { username: '', password: '' };
                
                // Limpiar campos
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } else {
                hablarTexto('No entend√≠ tu respuesta. Di "s√≠" para confirmar el inicio de sesi√≥n o "no" para cancelar.');
            }
            break;
    }
}

// Extraer valor de un comando de voz
function extraerValorComando(comando, palabrasClave) {
    console.log('üîç Extrayendo valor de comando:', comando);
    console.log('üîë Palabras clave a buscar:', palabrasClave);
    
    // Intentar con cada palabra clave en orden de prioridad
    for (const palabraClave of palabrasClave) {
        const regex = new RegExp(palabraClave + '\\s+(.+)', 'i');
        const match = comando.match(regex);
        if (match && match[1]) {
            const valorExtraido = match[1].trim();
            console.log(`‚úÖ Coincidencia encontrada con "${palabraClave}": "${valorExtraido}"`);
            return valorExtraido;
        }
    }
    
    // Si no se encuentra con regex, intentar de forma m√°s flexible
    for (const palabraClave of palabrasClave) {
        if (comando.includes(palabraClave)) {
            const indice = comando.indexOf(palabraClave);
            const valor = comando.substring(indice + palabraClave.length).trim();
            if (valor) {
                console.log(`‚úÖ Coincidencia flexible con "${palabraClave}": "${valor}"`);
                return valor;
            }
        }
    }
    
    console.log('‚ùå No se encontr√≥ ninguna coincidencia');
    return null;
}

// Funciones del asistente
function leerCamposFormulario() {
    const mensaje = 'El formulario de inicio de sesi√≥n tiene dos campos: Nombre de usuario y Contrase√±a. Puedes llenar estos campos de tres formas: 1. Manualmente con el teclado. 2. Usando comandos de voz individuales como: mi usuario es juan123. 3. O puedes hacer el inicio de sesi√≥n completo por voz presionando el bot√≥n "Iniciar Sesi√≥n por Voz" donde yo te guiar√© paso a paso.';
    hablarTexto(mensaje);
    agregarMensajeChat('Asistente', mensaje);
}

function ayudaContrase√±a() {
    const mensaje = 'Puedes ingresar tu contrase√±a de dos formas: 1. Manualmente usando el teclado para mayor seguridad. 2. O usando el modo de inicio de sesi√≥n por voz completo, donde yo recibir√© tu contrase√±a por voz de forma guiada. Ten en cuenta que al usar voz, otras personas podr√≠an escuchar tu contrase√±a.';
    hablarTexto(mensaje);
    agregarMensajeChat('Asistente', mensaje);
}

// NOTA: Esta funci√≥n ya no se usa - ahora usamos Vosk WebSocket con Push-to-Talk
// El reconocimiento se activa autom√°ticamente al mantener presionada la barra espaciadora
function iniciarReconocimientoVoz() {
    // Ya no necesitamos esta funci√≥n - Vosk maneja todo autom√°ticamente
    console.log('‚ÑπÔ∏è Sistema Vosk activo - usa Push-to-Talk (ESPACIO)');
    hablarTexto('Mant√©n presionada la barra espaciadora y habla');
}

function activarEscuchaDirecta() {
    if (reconocimientoVoz) {
        try {
            if (escuchandoComandos) {
                hablarTexto('El reconocimiento de voz ya est√° activo');
                return;
            }
            reconocimientoVoz.start();
            hablarTexto('Micr√≥fono activado, puedes hablar ahora');
        } catch (error) {
            console.error('Error al activar escucha:', error);
            hablarTexto('No se pudo activar el micr√≥fono. Verifica los permisos.');
            actualizarEstadoVoz('Error');
        }
    }
}

function actualizarEstadoVoz(estado) {
    const statusElement = document.getElementById('status-texto');
    if (statusElement) {
        statusElement.textContent = estado;
    }
}

function toggleVoz() {
    vozHabilitada = !vozHabilitada;
    document.getElementById('voz-habilitada').checked = vozHabilitada;
    
    if (vozHabilitada) {
        hablarTexto('Voz activada');
    } else {
        speechSynthesis.cancel();
    }
}

// Funciones del chat
function enviarMensajeConVoz() {
    const input = document.getElementById('chat-input');
    const mensaje = input.value.trim();
    
    if (!mensaje) return;
    
    // Agregar mensaje del usuario
    agregarMensajeChat('Usuario', mensaje);
    
    // Procesar como comando de voz tambi√©n
    procesarComandoVozLogin(mensaje.toLowerCase());
    
    // Simular respuesta del asistente si no fue procesado
    setTimeout(() => {
        const respuesta = generarRespuestaAsistenteLogin(mensaje);
        if (respuesta) {
            agregarMensajeChat('Asistente', respuesta);
            hablarTexto(respuesta);
        }
    }, 500);
    
    input.value = '';
}

function generarRespuestaAsistenteLogin(mensaje) {
    const mensajeLower = mensaje.toLowerCase();
    
    if (mensajeLower.includes('ayuda') || mensajeLower.includes('help')) {
        return '‚ú® Puedo ayudarte con el inicio de sesi√≥n de varias formas: 1. Di "mi usuario es..." para llenar el campo manualmente. 2. Presiona el bot√≥n "Iniciar Sesi√≥n por Voz" para que te gu√≠e en todo el proceso. 3. Llena el formulario con el teclado.';
    } else if (mensajeLower.includes('hola') || mensajeLower.includes('buenos')) {
        return 'üëã ¬°Hola! Bienvenido al asistente de inicio de sesi√≥n de VOCALCART. ¬øQuieres iniciar sesi√≥n por voz? Presiona el bot√≥n "Iniciar Sesi√≥n por Voz" y te guiar√© paso a paso.';
    } else if (mensajeLower.includes('gracias')) {
        return 'üòä ¬°De nada! Estoy aqu√≠ para ayudarte. Si necesitas algo m√°s, solo d√≠melo.';
    } else if (mensajeLower.includes('olvid√©') || mensajeLower.includes('olvide')) {
        return 'üîê Si olvidaste tu contrase√±a o usuario, contacta con el administrador del sistema. Por seguridad, no puedo ayudarte a recuperar esa informaci√≥n.';
    } else if (mensajeLower.includes('voz') || mensajeLower.includes('hablar') || mensajeLower.includes('dictado')) {
        return 'üéôÔ∏è ¬°Genial! Puedo ayudarte a iniciar sesi√≥n usando solo tu voz. Presiona el bot√≥n azul "Iniciar Sesi√≥n por Voz" y yo te guiar√© en cada paso del proceso.';
    }
    
    return null;
}

function agregarMensajeChat(remitente, mensaje) {
    const chatMessages = document.getElementById('chat-messages');
    const esAsistente = remitente === 'Asistente';
    
    const mensajeHTML = `
        <div class="message ${esAsistente ? 'asistente' : 'usuario'}-message mb-3">
            <div class="d-flex align-items-start">
                <div class="avatar ${esAsistente ? 'bg-primary' : 'bg-secondary'} text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-${esAsistente ? 'robot' : 'user'}" aria-hidden="true"></i>
                </div>
                <div class="message-content">
                    <strong>${remitente}:</strong>
                    <p class="mb-0">${mensaje}</p>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.innerHTML += mensajeHTML;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function limpiarChatConVoz() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = `
        <div class="message asistente-message mb-3">
            <div class="d-flex align-items-start">
                <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-robot" aria-hidden="true"></i>
                </div>
                <div class="message-content">
                    <strong>Asistente de Voz:</strong>
                    <p class="mb-2">¬°Hola! Soy tu asistente para el inicio de sesi√≥n en VOCALCART. Estoy aqu√≠ para ayudarte a acceder a tu cuenta de forma accesible.</p>
                    <div class="small text-muted">
                        üí° <strong>Tip:</strong> Puedes usar comandos de voz o escribir. Di "ayuda" para m√°s opciones.
                    </div>
                </div>
            </div>
        </div>
    `;
    
    hablarTexto('Nueva conversaci√≥n iniciada con el asistente de inicio de sesi√≥n');
}

// CSS para indicadores de estado
const style = document.createElement('style');
style.textContent = `
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #6c757d;
        animation: pulse 1s infinite;
    }
    
    .status-indicator.active {
        background-color: #28a745;
    }
    
    .status-indicator.speaking {
        background-color: #007bff;
    }
    
    .status-indicator.error {
        background-color: #dc3545;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .voz-control-container {
        z-index: 1050;
    }
    
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0,0,0,0);
        white-space: nowrap;
        border-width: 0;
    }
`;
document.head.appendChild(style);
</script>

<style>
    /* Estilos adicionales para las alertas de login */
    .alert {
        border: none;
        border-radius: 10px;
        animation: slideDown 0.5s ease-in-out;
        font-weight: 500;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #d1e7dd, #a3d3c4);
        color: #0f5132;
        border-left: 4px solid #198754;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #f8d7da, #f1aeb5);
        color: #842029;
        border-left: 4px solid #dc3545;
    }
    
    .alert-info {
        background: linear-gradient(135deg, #d1ecf1, #abdde5);
        color: #055160;
        border-left: 4px solid #0dcaf0;
    }
    
    @keyframes slideDown {
        from { 
            opacity: 0; 
            transform: translateY(-20px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }
    
    /* Efectos hover para las alertas */
    .alert:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
</style>
{% endblock contenido %}