{% extends 'base.html' %}
{% load static %}

{% block titulo %}
    VOCALCART - Registro de Usuario
{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{% static 'css/registro.css' %}">

<!-- Anunciador para lectores de pantalla -->
<div aria-live="assertive" aria-atomic="true" id="anunciador" class="sr-only"></div>
<div aria-live="polite" aria-atomic="true" id="anunciador-suave" class="sr-only"></div>

<!-- Control de Voz en Tiempo Real -->
<div class="voz-control-container position-fixed top-0 end-0 m-3" style="z-index: 9999;">
    <div class="card border-0 shadow-lg bg-primary text-white">
        <div class="card-body p-3">
            <div class="d-flex align-items-center mb-2">
                <h2 class="h6 mb-0 me-3">Control de Voz</h2>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="voz-habilitada" checked>
                    <label class="form-check-label text-white" for="voz-habilitada">
                        Activado
                    </label>
                </div>
            </div>
            
            <div class="btn-group w-100 mb-2" role="group" aria-label="Controles de voz">
                <button type="button" 
                        class="btn btn-success btn-sm" 
                        id="btn-escuchar"
                        aria-describedby="ayuda-escuchar">
                    <i class="fas fa-microphone me-1" aria-hidden="true"></i>
                    Escuchar
                </button>
                <button type="button" 
                        class="btn btn-warning btn-sm" 
                        id="btn-parar-voz"
                        aria-describedby="ayuda-parar">
                    <i class="fas fa-stop me-1" aria-hidden="true"></i>
                    Parar
                </button>
                <button type="button" 
                        class="btn btn-info btn-sm" 
                        id="btn-repetir"
                        aria-describedby="ayuda-repetir">
                    <i class="fas fa-redo me-1" aria-hidden="true"></i>
                    Repetir
                </button>
            </div>
            
            <div class="velocidad-voz mb-2">
                <label for="velocidad-voz" class="form-label small text-white">Velocidad:</label>
                <input type="range" 
                       class="form-range" 
                       id="velocidad-voz" 
                       min="0.5" 
                       max="2" 
                       step="0.1" 
                       value="1"
                       aria-describedby="ayuda-velocidad">
            </div>
            
            <div class="selector-voz mb-2">
                <label for="selector-voz" class="form-label small text-white">
                    <i class="fas fa-user-circle me-1"></i>Tipo de Voz:
                </label>
                <select id="selector-voz" class="form-select form-select-sm" aria-label="Seleccionar tipo de voz">
                    <option value="0">üéôÔ∏è Voz Predeterminada</option>
                    <option value="1">üë© Voz Femenina</option>
                    <option value="2">üë® Voz Masculina</option>
                </select>
            </div>
            
            <div class="estado-voz">
                <small class="text-white">
                    <i class="fas fa-circle me-1" id="indicador-voz" aria-hidden="true"></i>
                    <span id="estado-voz-texto">Voz lista</span>
                </small>
            </div>
            
            <!-- Transcript en tiempo real -->
            <div class="transcript-container mt-2 p-2 rounded" style="background-color: rgba(255, 255, 255, 0.1); min-height: 30px;">
                <small class="text-white-50">
                    <i class="fas fa-microphone me-1"></i>Transcript:
                </small>
                <div id="transcript-voz" class="text-white small mt-1" style="min-height: 20px; font-style: italic;">
                    Presiona ESPACIO para hablar...
                </div>
            </div>
            
            <!-- Instrucci√≥n Push-to-Talk -->
            <div class="mt-2 p-2 rounded text-center" style="background-color: rgba(13, 202, 240, 0.2); border: 1px solid rgba(13, 202, 240, 0.4);">
                <small class="text-info">
                    <i class="fas fa-keyboard me-1"></i>
                    <strong>Push-to-Talk:</strong> Mant√©n ESPACIO y habla
                </small>
            </div>
        </div>
    </div>
</div>

<div class="container vh-100 d-flex flex-column align-items-center justify-content-center register-container">
    <div class="card shadow-lg rounded-3 border-0" style="max-width: 450px; width: 100%; animation: fadeIn 0.8s ease-in-out;">
        <div class="card-body p-4 textoI" style="font-family: Lato;">
            
            <!-- Bot√≥n del Asistente de Voz -->
            <div class="d-flex justify-content-end mb-3">
                <button type="button" 
                        class="btn btn-primary btn-sm position-relative"
                        data-bs-toggle="modal" 
                        data-bs-target="#asistente-modal"
                        id="btn-asistente-voz"
                        data-voz="Abrir asistente virtual de voz para ayuda en el registro">
                    <i class="fas fa-robot me-2" aria-hidden="true"></i>
                    <span class="fw-bold">Asistente de Voz</span>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                        üîä
                    </span>
                </button>
            </div>

            <form action="{% url 'registrarse' %}" method="POST" id="registerForm">
                {% csrf_token %}
                
                <div class="text-center mb-4 logo-container">
                    <img src="{% static 'imgs/vocalcart.jpg' %}" 
                         alt="Logo de VOCALCART" 
                         style="max-width: 120px; height: auto;"
                         data-voz="Logo de VOCALCART, tu tienda accesible">
                    <h4 class="mt-3 mb-0" style="color: #198754; font-weight: bold;" data-voz="Formulario para crear cuenta en VOCALCART">Crear Cuenta</h4>
                    <p class="text-muted small mb-3" data-voz="√önete a VOCALCART y disfruta de una experiencia de compra accesible">√önete a VOCALCART</p>
                </div>
                
                <!-- Instrucciones de accesibilidad -->
                <div class="alert alert-info small mb-3" role="alert" data-voz="Instrucciones: Usa Tab para navegar entre campos, Alt V para activar o desactivar voz, Alt A para abrir asistente">
                    üîä <strong>Accesibilidad:</strong> Tab para navegar, Alt+V para voz, Alt+A para asistente
                </div>

                <!-- Nombre de usuario -->
                <div class="form-floating mb-3">
                    <input type="text" 
                           class="form-control" 
                           name="username" 
                           id="username" 
                           placeholder="Nombre de usuario" 
                           required
                           minlength="3"
                           maxlength="150"
                           autocomplete="username"
                           data-voz="Campo nombre de usuario, m√≠nimo 3 caracteres"
                           aria-describedby="ayuda-username">
                    <label for="username">
                        <i class="fas fa-user me-2"></i>Nombre de usuario
                    </label>
                    <div class="invalid-feedback">
                        El nombre de usuario debe tener al menos 3 caracteres.
                    </div>
                    <div id="ayuda-username" class="form-text">
                        El asistente de voz puede ayudarte a llenar este campo
                    </div>
                </div>

                <!-- Email -->
                <div class="form-floating mb-3">
                    <input type="email" 
                           class="form-control" 
                           name="email" 
                           id="email" 
                           placeholder="Correo electr√≥nico" 
                           required
                           autocomplete="email"
                           data-voz="Campo correo electr√≥nico"
                           aria-describedby="ayuda-email">
                    <label for="email">
                        <i class="fas fa-envelope me-2"></i>Correo electr√≥nico
                    </label>
                    <div class="invalid-feedback">
                        Por favor ingresa un correo electr√≥nico v√°lido.
                    </div>
                    <div id="ayuda-email" class="form-text">
                        El asistente de voz puede ayudarte a llenar este campo
                    </div>
                </div>

                <!-- Nombre -->
                <div class="form-floating mb-3">
                    <input type="text" 
                           class="form-control" 
                           name="first_name" 
                           id="first_name" 
                           placeholder="Nombre" 
                           required
                           maxlength="30"
                           autocomplete="given-name"
                           data-voz="Campo nombre"
                           aria-describedby="ayuda-firstname">
                    <label for="first_name">
                        <i class="fas fa-id-card me-2"></i>Nombre
                    </label>
                    <div class="invalid-feedback">
                        Por favor ingresa tu nombre.
                    </div>
                    <div id="ayuda-firstname" class="form-text">
                        El asistente de voz puede ayudarte a llenar este campo
                    </div>
                </div>

                <!-- Apellido -->
                <div class="form-floating mb-3">
                    <input type="text" 
                           class="form-control" 
                           name="last_name" 
                           id="last_name" 
                           placeholder="Apellido" 
                           required
                           maxlength="30"
                           autocomplete="family-name"
                           data-voz="Campo apellido"
                           aria-describedby="ayuda-lastname">
                    <label for="last_name">
                        <i class="fas fa-id-card me-2"></i>Apellido
                    </label>
                    <div class="invalid-feedback">
                        Por favor ingresa tu apellido.
                    </div>
                    <div id="ayuda-lastname" class="form-text">
                        El asistente de voz puede ayudarte a llenar este campo
                    </div>
                </div>

                <!-- Contrase√±a -->
                <div class="form-floating mb-3">
                    <input type="password" 
                           class="form-control" 
                           name="password1" 
                           id="password1" 
                           placeholder="Contrase√±a" 
                           required
                           minlength="8"
                           autocomplete="new-password"
                           data-voz="Campo contrase√±a, m√≠nimo 8 caracteres. Por seguridad, este campo debe ser llenado manualmente"
                           aria-describedby="ayuda-password1">
                    <label for="password1">
                        <i class="fas fa-lock me-2"></i>Contrase√±a
                    </label>
                    <div class="password-strength" id="passwordStrength"></div>
                    <div class="form-text">
                        <small class="text-muted">La contrase√±a debe tener al menos 8 caracteres.</small>
                    </div>
                    <div class="invalid-feedback" id="password1Feedback">
                        La contrase√±a debe tener al menos 8 caracteres.
                    </div>
                    <div id="ayuda-password1" class="form-text text-warning">
                        üîí <strong>Por seguridad:</strong> Este campo NO usa asistente de voz. Debes ingresar tu contrase√±a manualmente.
                    </div>
                </div>

                <!-- Confirmar contrase√±a -->
                <div class="form-floating mb-3">
                    <input type="password" 
                           class="form-control" 
                           name="password2" 
                           id="password2" 
                           placeholder="Confirmar contrase√±a" 
                           required
                           minlength="8"
                           autocomplete="new-password"
                           data-voz="Campo confirmar contrase√±a. Por seguridad, este campo debe ser llenado manualmente"
                           aria-describedby="ayuda-password2">
                    <label for="password2">
                        <i class="fas fa-lock me-2"></i>Confirmar contrase√±a
                    </label>
                    <div class="invalid-feedback" id="password2Feedback">
                        Las contrase√±as no coinciden.
                    </div>
                    <div id="ayuda-password2" class="form-text text-warning">
                        üîí <strong>Por seguridad:</strong> Este campo NO usa asistente de voz. Debes confirmar tu contrase√±a manualmente.
                    </div>
                </div>

                <!-- T√©rminos y condiciones -->
                <div class="form-check mb-3">
                    <input class="form-check-input" 
                           type="checkbox" 
                           id="terms" 
                           name="terms" 
                           required
                           data-voz="Casilla de aceptaci√≥n de t√©rminos y condiciones">
                    <label class="form-check-label small" for="terms">
                        Acepto los <a href="#" class="register-link">t√©rminos y condiciones</a> y la <a href="#" class="register-link">pol√≠tica de privacidad</a>
                    </label>
                    <div class="invalid-feedback">
                        Debes aceptar los t√©rminos y condiciones.
                    </div>
                </div>

                <!-- Bot√≥n de registro -->
                <div class="d-grid gap-2 mb-3">
                    <button type="submit" 
                            class="btn btn-success btn-lg btn-register" 
                            name="register" 
                            id="submitBtn"
                            style="font-family: Lato;"
                            data-voz="Bot√≥n crear cuenta. Al presionar este bot√≥n se confirmar√° tu registro">
                        <i class="fas fa-user-plus me-2"></i> Crear cuenta
                    </button>
                </div>

                <!-- Mensajes de error o √©xito -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} alert-dismissible fade show" role="alert">
                            {% if message.tags == 'error' %}
                                <i class="fas fa-exclamation-triangle me-2"></i>
                            {% else %}
                                <i class="fas fa-check-circle me-2"></i>
                            {% endif %}
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- Mostrar errores del formulario -->
                {% if form.errors %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error en el formulario:</strong>
                        <ul class="mb-0 mt-2">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endif %}

                <!-- Link para volver al login -->
                <div class="text-center">
                    <p class="small mb-0">
                        ¬øYa tienes una cuenta? 
                        <a href="{% url 'login' %}" class="register-link">
                            <i class="fas fa-sign-in-alt me-1"></i>Iniciar sesi√≥n
                        </a>
                    </p>
                </div>

            </form>
        </div>
    </div> 
    
    <div class="text-center mt-3" style="color: white;">
        UNEMI - VOCALCART &copy V0.0
    </div>
</div>

<!-- Modal de Asistente de Voz -->
<div class="modal fade" id="asistente-modal" tabindex="-1" aria-labelledby="asistente-modal-title" aria-describedby="asistente-modal-descripcion">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h2 class="modal-title h4" id="asistente-modal-title" data-voz="Asistente virtual de voz para ayuda en el registro">
                    <i class="fas fa-robot me-3" aria-hidden="true"></i>
                    üîä Asistente de Voz - Registro
                </h2>
                <button type="button" 
                        class="btn-close btn-close-white" 
                        data-bs-dismiss="modal" 
                        aria-label="Cerrar asistente virtual"
                        data-voz="Cerrar asistente virtual"></button>
            </div>
            <div class="modal-body">
                <div id="asistente-modal-descripcion" class="mb-4">
                    <div class="alert alert-info" data-voz="Bienvenido al asistente de voz para registro. Puedo ayudarte a llenar los campos del formulario">
                        <h3 class="h5 mb-2">üéØ ¬°Bienvenido al Asistente de Registro!</h3>
                        <p class="mb-2">Soy tu asistente especializado para personas con discapacidad visual. Puedo:</p>
                        <ul class="mb-2">
                            <li>üó£Ô∏è Leer los campos del formulario</li>
                            <li>‚úçÔ∏è Ayudarte a llenar el formulario con voz</li>
                            <li>üìù Explicar los requisitos de cada campo</li>
                            <li>üîí Indicarte cu√°ndo debes ingresar tu contrase√±a</li>
                            <li>‚úÖ Confirmar tu registro</li>
                        </ul>
                        <p class="mb-0 text-danger"><strong>‚ö†Ô∏è Importante:</strong> Por seguridad, los campos de contrase√±a NO usan el asistente de voz y deben ser llenados manualmente.</p>
                    </div>
                </div>
                
                <!-- Controles de voz del asistente -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h4 class="h6 mb-3" data-voz="Comandos de voz disponibles para el registro">üé§ Comandos de Voz:</h4>
                                
                                <!-- Instrucci√≥n Push-to-Talk destacada -->
                                <div class="alert alert-primary mb-3" role="alert">
                                    <strong><i class="fas fa-keyboard me-1"></i>Push-to-Talk:</strong>
                                    <br>Mant√©n presionada la tecla <kbd>ESPACIO</kbd> y habla
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-sm text-start" onclick="hablarTexto('Di: mi usuario es, seguido de tu nombre de usuario')">
                                        "mi usuario es [nombre]"
                                    </button>
                                    <button class="btn btn-success btn-sm text-start" onclick="hablarTexto('Di: mi email es, seguido de tu correo. Por ejemplo: danny arroba gmail punto com')">
                                        "mi email es [correo]"
                                    </button>
                                    <button class="btn btn-success btn-sm text-start" onclick="hablarTexto('Di: mi nombre es, seguido de tu nombre')">
                                        "mi nombre es [tu nombre]"
                                    </button>
                                    <button class="btn btn-success btn-sm text-start" onclick="hablarTexto('Di: registrar, para crear tu cuenta')">
                                        "registrar"
                                    </button>
                                    <button class="btn btn-primary btn-sm text-start" onclick="hablarTexto('Di: iniciar sesi√≥n, para volver al login')">
                                        <i class="fas fa-sign-in-alt me-1"></i>"iniciar sesi√≥n"
                                    </button>
                                    <button class="btn btn-info btn-sm text-start" onclick="leerCamposFormulario()">
                                        "leer campos"
                                    </button>
                                    <button class="btn btn-secondary btn-sm text-start" onclick="hablarTexto('Di: ayuda, para obtener informaci√≥n')">
                                        "ayuda"
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h4 class="h6 mb-3" data-voz="Estado del reconocimiento de voz">üéØ Estado de Voz:</h4>
                                <div id="reconocimiento-estado" class="mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="status-indicator me-2" id="status-voz"></div>
                                        <span id="status-texto">Voz lista</span>
                                    </div>
                                    <button class="btn btn-primary w-100" id="btn-iniciar-reconocimiento" onclick="iniciarReconocimientoVoz()">
                                        <i class="fas fa-microphone me-2"></i>
                                        Iniciar Reconocimiento de Voz
                                    </button>
                                </div>
                                <div class="small text-muted">
                                    üí° Di comandos como: "mi nombre de usuario es...", "mi email es...", "mi nombre es..."
                                </div>
                                
                                <!-- Bot√≥n de ayuda para permisos -->
                                <div class="mt-3">
                                    <button class="btn btn-outline-info btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#ayudaPermisos" aria-expanded="false">
                                        <i class="fas fa-question-circle me-2"></i>
                                        ¬øProblemas con el micr√≥fono?
                                    </button>
                                    <div class="collapse mt-2" id="ayudaPermisos">
                                        <div class="card card-body bg-info bg-opacity-10">
                                            <h6 class="text-info mb-2">
                                                <i class="fas fa-info-circle me-2"></i>
                                                C√≥mo habilitar el micr√≥fono:
                                            </h6>
                                            <ol class="small mb-0 ps-3">
                                                <li class="mb-2">
                                                    <strong>Chrome/Edge:</strong> Haz clic en el icono de candado üîí en la barra de direcciones
                                                </li>
                                                <li class="mb-2">
                                                    <strong>Selecciona:</strong> "Permisos del sitio" o "Configuraci√≥n del sitio"
                                                </li>
                                                <li class="mb-2">
                                                    <strong>Micr√≥fono:</strong> Cambia de "Bloqueado" a "Permitir"
                                                </li>
                                                <li class="mb-0">
                                                    <strong>Recarga:</strong> Actualiza la p√°gina y prueba de nuevo
                                                </li>
                                            </ol>
                                            <div class="alert alert-warning small mb-0 mt-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                <strong>Nota:</strong> Firefox tiene soporte limitado. Usa Chrome o Edge para mejor experiencia.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat del asistente -->
                <div class="chat-container">
                    <div class="chat-messages border rounded p-3 mb-3" 
                         id="chat-messages" 
                         role="log" 
                         aria-live="polite" 
                         aria-label="Conversaci√≥n con el asistente"
                         style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                        
                        <div class="message asistente-message mb-3">
                            <div class="d-flex align-items-start">
                                <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-robot" aria-hidden="true"></i>
                                </div>
                                <div class="message-content">
                                    <strong>Asistente de Voz:</strong>
                                    <p class="mb-2">¬°Hola! Soy tu asistente para el registro en VOCALCART. Estoy aqu√≠ para ayudarte a crear tu cuenta de forma accesible.</p>
                                    <div class="small text-muted">
                                        üí° <strong>Tip:</strong> Puedes usar comandos de voz o escribir. Di "ayuda" para m√°s opciones.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input para chat -->
                    <div class="input-group">
                        <label for="chat-input" class="sr-only">Escribir mensaje al asistente</label>
                        <input type="text" 
                               id="chat-input" 
                               class="form-control form-control-lg" 
                               placeholder="Escribe tu pregunta o usa comandos de voz..." 
                               aria-describedby="ayuda-chat">
                        <button type="button" 
                                class="btn btn-primary" 
                                onclick="enviarMensajeConVoz()"
                                aria-label="Enviar mensaje">
                            <i class="fas fa-paper-plane" aria-hidden="true"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-success" 
                                onclick="activarEscuchaDirecta()"
                                aria-label="Activar micr√≥fono">
                            <i class="fas fa-microphone" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div id="ayuda-chat" class="form-text">
                        Presiona Enter para enviar o usa el micr√≥fono para hablar directamente
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-voz="Cerrar asistente">
                    <i class="fas fa-times me-2" aria-hidden="true"></i>
                    Cerrar
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="limpiarChatConVoz()" data-voz="Iniciar nueva conversaci√≥n">
                    <i class="fas fa-refresh me-2" aria-hidden="true"></i>
                    Nueva Conversaci√≥n
                </button>
                <button type="button" class="btn btn-info" onclick="iniciarRegistroPorVoz()" data-voz="Iniciar proceso de registro completamente por voz">
                    <i class="fas fa-microphone-alt me-2" aria-hidden="true"></i>
                    üéôÔ∏è Registrarse por Voz
                </button>
                <button type="button" class="btn btn-success" onclick="leerCamposFormulario()" data-voz="Leer todos los campos del formulario">
                    <i class="fas fa-volume-up me-2" aria-hidden="true"></i>
                    Leer Formulario
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales para funcionalidad de voz
let vozHabilitada = true;
let reconocimientoVoz = null;
let vozActual = null;
let vocesDisponibles = [];
let velocidadVoz = 1;
let ultimoTextoHablado = '';
let escuchandoComandos = false;

// Variables para Vosk WebSocket (reconocimiento offline - IGUAL QUE LOGIN)
let voskWebSocket = null;
let audioContext = null;
let mediaStream = null;
let audioProcessor = null;
let isPushToTalkActive = false;

// Variables para el flujo de registro por voz
let modoRegistroPorVoz = false;
let datosRegistroVoz = {
    username: '',
    email: '',
    first_name: '',
    last_name: '',
    password1: '',
    password2: ''
};
let pasoActualRegistro = 0;

// Inicializaci√≥n de funciones de voz
document.addEventListener('DOMContentLoaded', function() {
    inicializarVoz();
    configurarAtajosTeclado();
    configurarEventosVoz();
    configurarCamposConVoz();
    
    // Anunciar carga de p√°gina despu√©s de un delay
    setTimeout(() => {
        if (vozHabilitada) {
            hablarTexto('Bienvenido a VOCALCART, tienda accesible. P√°gina de registro cargada. Crea tu nueva cuenta usando comandos de voz. Presiona ESPACIO y di: mi usuario es, seguido de tu nombre de usuario. Si ya tienes cuenta, di: iniciar sesi√≥n.');
        }
    }, 1500);
    
    // Mantener la validaci√≥n original del formulario
    inicializarValidacionFormulario();
});

// Inicializar s√≠ntesis de voz Y reconocimiento Vosk
function inicializarVoz() {
    if ('speechSynthesis' in window) {
        // Configurar voces en espa√±ol
        function cargarVoces() {
            vocesDisponibles = speechSynthesis.getVoices();
            const vocesEspanol = vocesDisponibles.filter(voz => voz.lang.startsWith('es'));
            
            if (vocesEspanol.length > 0) {
                // Intentar encontrar diferentes tipos de voces
                const vozFemenina = vocesEspanol.find(voz => 
                    voz.name.toLowerCase().includes('female') || 
                    voz.name.toLowerCase().includes('femenina') ||
                    voz.name.toLowerCase().includes('woman') ||
                    voz.name.toLowerCase().includes('zira') ||
                    voz.name.toLowerCase().includes('helena') ||
                    voz.name.toLowerCase().includes('monica')
                );
                
                const vozMasculina = vocesEspanol.find(voz => 
                    voz.name.toLowerCase().includes('male') || 
                    voz.name.toLowerCase().includes('masculina') ||
                    voz.name.toLowerCase().includes('man') ||
                    voz.name.toLowerCase().includes('diego') ||
                    voz.name.toLowerCase().includes('jorge')
                );
                
                // Configurar array de voces disponibles
                vocesDisponibles = [
                    vocesEspanol[0], // Voz predeterminada
                    vozFemenina || vocesEspanol[1] || vocesEspanol[0], // Voz femenina
                    vozMasculina || vocesEspanol[2] || vocesEspanol[0]  // Voz masculina
                ];
                
                vozActual = vocesDisponibles[0]; // Establecer la primera por defecto
                
                console.log('Voces cargadas:', vocesDisponibles.map(v => v.name));
            }
        }
        
        // Cargar voces
        cargarVoces();
        speechSynthesis.onvoiceschanged = cargarVoces;
        
        // ========== NUEVO: Conectar a Vosk WebSocket (IGUAL QUE LOGIN) ==========
        conectarVoskWebSocket();
        
        // Inicializar captura de audio
        inicializarCapturaAudio();
        
    } else {
        console.warn('S√≠ntesis de voz no soportada en este navegador');
    }
}

// ========== FUNCIONES VOSK WEBSOCKET (COPIADAS DEL LOGIN) ==========

function conectarVoskWebSocket() {
    try {
        voskWebSocket = new WebSocket('ws://localhost:8000/ws/voice/');

        voskWebSocket.onopen = () => {
            console.log('‚úÖ WebSocket Vosk conectado - Reconocimiento offline listo');
            actualizarEstadoVoz('Presiona ESPACIO para hablar');
            
            const transcriptElement = document.getElementById('transcript-voz');
            if (transcriptElement) {
                transcriptElement.textContent = 'Presiona ESPACIO para hablar...';
                transcriptElement.style.color = '#10b981';
            }
        };

        voskWebSocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const transcriptElement = document.getElementById('transcript-voz');
            
            switch(data.type) {
                case 'ready':
                    console.log('üé§ Vosk listo:', data.message);
                    break;
                
                case 'partial':
                    console.log('üéôÔ∏è Parcial:', data.transcript);
                    if (transcriptElement) {
                        transcriptElement.textContent = data.transcript;
                        transcriptElement.style.fontWeight = 'normal';
                        transcriptElement.style.color = '#0dcaf0';
                    }
                    break;
                
                case 'result':
                case 'final':
                    console.log('‚úÖ Final:', data.transcript);
                    if (transcriptElement) {
                        transcriptElement.textContent = `‚úì ${data.transcript}`;
                        transcriptElement.style.fontWeight = 'bold';
                        transcriptElement.style.color = '#10b981';
                    }
                    
                    // Procesar el comando
                    procesarComandoVozRegistro(data.transcript.toLowerCase().trim());
                    break;
                
                case 'error':
                    console.error('‚ùå Error Vosk:', data.message);
                    actualizarEstadoVoz(`Error: ${data.message}`);
                    if (transcriptElement) {
                        transcriptElement.textContent = `‚ùå Error: ${data.message}`;
                        transcriptElement.style.color = '#dc3545';
                    }
                    break;
            }
        };

        voskWebSocket.onerror = (error) => {
            console.error('‚ùå Error WebSocket:', error);
            actualizarEstadoVoz('Error de conexi√≥n');
        };

        voskWebSocket.onclose = () => {
            console.log('üîå WebSocket desconectado - Intentando reconectar...');
            actualizarEstadoVoz('Reconectando...');
            setTimeout(conectarVoskWebSocket, 3000);
        };

    } catch (error) {
        console.error('‚ùå Error al conectar WebSocket:', error);
    }
}

async function inicializarCapturaAudio() {
    try {
        console.log('üé§ Solicitando permisos de micr√≥fono...');
        mediaStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                channelCount: 1,
                sampleRate: 16000,
                echoCancellation: true,
                noiseSuppression: true,
            } 
        });
        
        console.log('‚úÖ Permisos de micr√≥fono concedidos');
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 16000
        });

        const source = audioContext.createMediaStreamSource(mediaStream);
        audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);
        
        audioProcessor.onaudioprocess = (e) => {
            if (!isPushToTalkActive || !voskWebSocket || voskWebSocket.readyState !== WebSocket.OPEN) {
                return;
            }

            const audioData = e.inputBuffer.getChannelData(0);
            const pcmData = new Int16Array(audioData.length);
            
            for (let i = 0; i < audioData.length; i++) {
                pcmData[i] = Math.max(-1, Math.min(1, audioData[i])) * 0x7FFF;
            }
            
            voskWebSocket.send(pcmData.buffer);
        };
        
        source.connect(audioProcessor);
        audioProcessor.connect(audioContext.destination);
        
        console.log('‚úÖ Captura de audio inicializada');
        hablarTexto('Sistema de reconocimiento de voz listo. Mant√©n presionada la barra espaciadora para hablar.');
        
    } catch (error) {
        console.error('‚ùå Error al inicializar audio:', error);
        hablarTexto('No se pudo acceder al micr√≥fono. Verifica los permisos en tu navegador.');
        actualizarEstadoVoz('Error: Sin acceso al micr√≥fono');
    }
}

// ========== FIN FUNCIONES VOSK ==========                        actualizarEstadoVoz('Error de red');
                        break;
                    default:
                        mensajeError = 'Error en reconocimiento de voz: ' + event.error;
                        actualizarEstadoVoz('Error: ' + event.error);
                }
                
                console.warn(mensajeError);
                // No hablar el error para evitar loops
            };
            
            reconocimientoVoz.onstart = function() {
                actualizarEstadoVoz('Escuchando...');
                escuchandoComandos = true;
                const statusVoz = document.getElementById('status-voz');
                if (statusVoz) {
                    statusVoz.className = 'status-indicator active';
                }
            };
            
            reconocimientoVoz.onend = function() {
                actualizarEstadoVoz('Voz lista');
                escuchandoComandos = false;
                const statusVoz = document.getElementById('status-voz');
                if (statusVoz) {
                    statusVoz.className = 'status-indicator';
                }
            };
        }
    } else {
        console.warn('S√≠ntesis de voz no soportada en este navegador');
    }
}

// Funci√≥n principal para hablar texto
function hablarTexto(texto, interrumpir = true) {
    if (!vozHabilitada || !texto) return;
    
    if (interrumpir) {
        speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(texto);
    utterance.lang = 'es-ES';
    utterance.rate = velocidadVoz;
    utterance.pitch = 1;
    utterance.volume = 1;
    
    if (vozActual) {
        utterance.voice = vozActual;
    }
    
    ultimoTextoHablado = texto;
    
    utterance.onstart = function() {
        document.getElementById('indicador-voz').className = 'fas fa-circle text-success';
        document.getElementById('estado-voz-texto').textContent = 'Hablando...';
    };
    
    utterance.onend = function() {
        document.getElementById('indicador-voz').className = 'fas fa-circle text-secondary';
        document.getElementById('estado-voz-texto').textContent = 'Voz lista';
    };
    
    speechSynthesis.speak(utterance);
    
    // Anunciar en regi√≥n ARIA
    const anunciador = document.getElementById('anunciador');
    if (anunciador) {
        anunciador.textContent = texto;
        setTimeout(() => anunciador.textContent = '', 100);
    }
}

// Configurar atajos de teclado
function configurarAtajosTeclado() {
    let spacebarPressed = false;
    
    document.addEventListener('keydown', function(e) {
        // Push-to-Talk: Spacebar para activar reconocimiento VOSK
        if (e.code === 'Space' && !e.repeat && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            if (!spacebarPressed && vozHabilitada) {
                spacebarPressed = true;
                isPushToTalkActive = true; // Activar bandera para Vosk
                actualizarEstadoVoz('üéôÔ∏è Escuchando...');
                console.log('üé§ Push-to-Talk ACTIVADO');
            }
        }
        
        // Alt + V: Activar/Desactivar voz
        if (e.altKey && e.key === 'v') {
            e.preventDefault();
            toggleVoz();
        }
        
        // Alt + A: Abrir asistente
        if (e.altKey && e.key === 'a') {
            e.preventDefault();
            document.getElementById('btn-asistente-voz').click();
        }
        
        // Escape: Parar voz
        if (e.key === 'Escape') {
            speechSynthesis.cancel();
        }
        
        // Enter en chat
        if (e.key === 'Enter' && e.target.id === 'chat-input') {
            e.preventDefault();
            enviarMensajeConVoz();
        }
    });
    
    document.addEventListener('keyup', function(e) {
        // Push-to-Talk: Soltar spacebar para detener reconocimiento VOSK
        if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            if (spacebarPressed) {
                spacebarPressed = false;
                isPushToTalkActive = false; // Desactivar bandera para Vosk
                actualizarEstadoVoz('Voz lista');
                console.log('üé§ Push-to-Talk DESACTIVADO');
                
                // Enviar comando final para procesar
                if (voskWebSocket && voskWebSocket.readyState === WebSocket.OPEN) {
                    voskWebSocket.send(JSON.stringify({ action: 'finish' }));
                }
            }
        }
    });
}

// Configurar eventos espec√≠ficos de voz
function configurarEventosVoz() {
    // Toggle de voz
    document.getElementById('voz-habilitada').addEventListener('change', function() {
        vozHabilitada = this.checked;
        if (vozHabilitada) {
            hablarTexto('Voz activada');
        } else {
            speechSynthesis.cancel();
        }
    });
    
    // Control de velocidad
    document.getElementById('velocidad-voz').addEventListener('input', function() {
        velocidadVoz = parseFloat(this.value);
        hablarTexto(`Velocidad cambiada a ${Math.round(velocidadVoz * 100)} por ciento`, true);
    });
    
    // Selector de voz
    document.getElementById('selector-voz').addEventListener('change', function() {
        const indiceVoz = parseInt(this.value);
        if (vocesDisponibles[indiceVoz]) {
            vozActual = vocesDisponibles[indiceVoz];
            const tipoVoz = this.options[this.selectedIndex].text;
            hablarTexto(`Voz cambiada a ${tipoVoz}. Esta es una prueba de la nueva voz.`);
        }
    });
    
    // Botones de control
    document.getElementById('btn-escuchar').addEventListener('click', iniciarReconocimientoVoz);
    document.getElementById('btn-parar-voz').addEventListener('click', function() {
        speechSynthesis.cancel();
        if (reconocimientoVoz && escuchandoComandos) {
            reconocimientoVoz.stop();
        }
        hablarTexto('Voz detenida');
    });
    document.getElementById('btn-repetir').addEventListener('click', function() {
        if (ultimoTextoHablado) {
            hablarTexto(ultimoTextoHablado);
        }
    });
}

// Configurar campos del formulario con retroalimentaci√≥n de voz
function configurarCamposConVoz() {
    // Agregar eventos de focus y blur a todos los campos con data-voz
    document.querySelectorAll('[data-voz]').forEach(elemento => {
        elemento.addEventListener('focus', function() {
            const textoVoz = this.getAttribute('data-voz');
            if (textoVoz && vozHabilitada) {
                hablarTexto(textoVoz);
            }
        });
    });
    
    // Eventos espec√≠ficos para campos del formulario (excepto contrase√±as)
    const camposTexto = ['username', 'email', 'first_name', 'last_name'];
    camposTexto.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
            campo.addEventListener('input', function() {
                // Retroalimentaci√≥n silenciosa durante escritura
            });
            
            campo.addEventListener('blur', function() {
                if (this.value && vozHabilitada) {
                    const label = this.previousElementSibling || this.parentElement.querySelector('label');
                    const nombreCampo = label ? label.textContent.trim() : 'Campo';
                    hablarTexto(`${nombreCampo} ingresado`);
                }
            });
        }
    });
}

// Procesar comandos de voz espec√≠ficos para registro
function procesarComandoVozRegistro(comando) {
    console.log('üé§ Comando recibido:', comando);
    
    // Si estamos en modo registro por voz, procesar el flujo
    if (modoRegistroPorVoz) {
        procesarFlujoRegistroPorVoz(comando);
        return;
    }
    
    // ========== DETECCI√ìN MEJORADA Y R√ÅPIDA ==========
    
    // Comando para nombre de usuario
    if (comando.includes('mi usuario es') || 
        comando.includes('mi nombre de usuario es') ||
        comando.includes('usuario es') ||
        comando.includes('nombre de usuario es')) {
        
        const patrones = ['mi usuario es', 'mi nombre de usuario es', 'usuario es', 'nombre de usuario es', 'usuario'];
        const valorExtraido = extraerValorComando(comando, patrones);
        
        if (valorExtraido) {
            document.getElementById('username').value = valorExtraido;
            console.log('‚úÖ Usuario establecido:', valorExtraido);
            hablarTexto(`Usuario ${valorExtraido}`);
            resaltarCampo('username');
        }
        return;
    }
    
    // Comando para email
    if (comando.includes('mi email es') || 
        comando.includes('mi correo es') ||
        comando.includes('email es') ||
        comando.includes('correo es')) {
        
        const patrones = ['mi email es', 'mi correo es', 'email es', 'correo es', 'email', 'correo'];
        const valorExtraido = extraerValorComando(comando, patrones);
        
        if (valorExtraido) {
            // Convertir "arroba" a "@" y "punto" a "."
            let emailFormateado = valorExtraido
                .replace(/arroba/g, '@')
                .replace(/\s+punto\s+/g, '.')
                .replace(/\s+/g, '');
            
            document.getElementById('email').value = emailFormateado;
            console.log('‚úÖ Email establecido:', emailFormateado);
            hablarTexto(`Email ${emailFormateado}`);
            resaltarCampo('email');
        }
        return;
    }
    
    // Comando para nombre
    if (comando.includes('mi nombre es')) {
        const valorExtraido = extraerValorComando(comando, ['mi nombre es']);
        if (valorExtraido) {
            // Capitalizar primera letra
            const nombreFormateado = valorExtraido.charAt(0).toUpperCase() + valorExtraido.slice(1);
            document.getElementById('first_name').value = nombreFormateado;
            console.log('‚úÖ Nombre establecido:', nombreFormateado);
            hablarTexto(`Nombre ${nombreFormateado}`);
            resaltarCampo('first_name');
        }
        return;
    }
    
    // Comando para apellido
    if (comando.includes('mi apellido es')) {
        const valorExtraido = extraerValorComando(comando, ['mi apellido es']);
        if (valorExtraido) {
            // Capitalizar primera letra
            const apellidoFormateado = valorExtraido.charAt(0).toUpperCase() + valorExtraido.slice(1);
            document.getElementById('last_name').value = apellidoFormateado;
            console.log('‚úÖ Apellido establecido:', apellidoFormateado);
            hablarTexto(`Apellido ${apellidoFormateado}`);
            resaltarCampo('last_name');
        }
        return;
    }
    
    // Comando para contrase√±a
    if (comando.includes('mi contrase√±a es') ||
        comando.includes('mi clave es') ||
        comando.includes('contrase√±a es')) {
        
        const patrones = ['mi contrase√±a es', 'mi clave es', 'contrase√±a es', 'contrase√±a'];
        const valorExtraido = extraerValorComando(comando, patrones);
        
        if (valorExtraido) {
            document.getElementById('password1').value = valorExtraido;
            console.log('‚úÖ Contrase√±a establecida');
            hablarTexto('Contrase√±a ingresada');
            resaltarCampo('password1');
        }
        return;
    }
    
    // Comando para confirmar contrase√±a
    if (comando.includes('confirmar contrase√±a') ||
        comando.includes('repetir contrase√±a') ||
        comando.includes('confirmar clave')) {
        
        const patrones = ['confirmar contrase√±a', 'repetir contrase√±a', 'confirmar clave'];
        const valorExtraido = extraerValorComando(comando, patrones);
        
        if (valorExtraido) {
            document.getElementById('password2').value = valorExtraido;
            console.log('‚úÖ Confirmaci√≥n de contrase√±a establecida');
            hablarTexto('Confirmaci√≥n ingresada');
            resaltarCampo('password2');
        }
        return;
    }
    
    // Comando para registrarse
    if (comando.includes('registrar') ||
        comando.includes('crear cuenta') ||
        comando.includes('registrarse')) {
        
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const firstname = document.getElementById('first_name').value;
        const lastname = document.getElementById('last_name').value;
        const password1 = document.getElementById('password1').value;
        const password2 = document.getElementById('password2').value;
        
        if (!username || !email || !firstname || !lastname || !password1 || !password2) {
            hablarTexto('Falta completar algunos campos');
            return;
        }
        
        hablarTexto('Creando cuenta');
        setTimeout(() => {
            document.getElementById('registerForm').submit();
        }, 500);
        return;
    }
    
    // Comando para limpiar
    if (comando.includes('limpiar') || comando.includes('borrar')) {
        document.getElementById('username').value = '';
        document.getElementById('email').value = '';
        document.getElementById('first_name').value = '';
        document.getElementById('last_name').value = '';
        document.getElementById('password1').value = '';
        document.getElementById('password2').value = '';
        hablarTexto('Campos limpiados');
        return;
    }
    
    // ========== NUEVO: Comandos para ir al login ==========
    if (comando.includes('iniciar sesi√≥n') ||
        comando.includes('ir al login') ||
        comando.includes('ya tengo cuenta') ||
        comando.includes('volver al login') ||
        comando.includes('tengo cuenta')) {
        
        hablarTexto('Te llevar√© a la p√°gina de inicio de sesi√≥n.');
        setTimeout(() => {
            window.location.href = '/login/';
        }, 1500);
        return;
    }
    
    // Comando para iniciar registro por voz guiado
    if (comando.includes('registrarse por voz') ||
        comando.includes('registro por voz') ||
        comando.includes('crear cuenta por voz')) {
        iniciarRegistroPorVoz();
        return;
    }
    
    // Comandos informativos
    if (comando.includes('ayuda') || comando.includes('c√≥mo') || comando.includes('como')) {
        leerCamposFormulario();
        return;
    }
    
    if (comando.includes('leer') || comando.includes('campos')) {
        leerCamposFormulario();
        return;
    }
    
    if (comando.includes('requisitos') || comando.includes('necesito')) {
        leerRequisitos();
        return;
    }
    
    console.log('‚ö†Ô∏è Comando no reconocido:', comando);
}

// Funci√≥n para resaltar campo con borde verde
function resaltarCampo(campoId) {
    const campo = document.getElementById(campoId);
    if (campo) {
        campo.style.borderColor = '#10b981';
        campo.style.borderWidth = '2px';
        setTimeout(() => {
            campo.style.borderColor = '';
            campo.style.borderWidth = '';
        }, 2000);
    }
}

// Iniciar el proceso de registro completamente por voz
function iniciarRegistroPorVoz() {
    modoRegistroPorVoz = true;
    pasoActualRegistro = 0;
    datosRegistroVoz = { username: '', email: '', first_name: '', last_name: '', password1: '', password2: '' };
    
    const mensaje = 'üéôÔ∏è ¬°Perfecto! Vamos a crear tu cuenta usando solo tu voz. Te guiar√© paso a paso. Primero, dime el nombre de usuario que deseas usar. Por ejemplo: juan123';
    hablarTexto(mensaje);
    agregarMensajeChat('Asistente', mensaje);
    
    // Activar reconocimiento de voz autom√°ticamente
    if (reconocimientoVoz && !escuchandoComandos) {
        setTimeout(() => {
            reconocimientoVoz.start();
        }, 3000);
    }
}

// Procesar el flujo guiado de registro por voz
function procesarFlujoRegistroPorVoz(comando) {
    switch(pasoActualRegistro) {
        case 0: // Esperando nombre de usuario
            if (comando.length > 2) {
                datosRegistroVoz.username = comando.trim();
                document.getElementById('username').value = datosRegistroVoz.username;
                
                const mensaje = `‚úÖ Perfecto, nombre de usuario "${datosRegistroVoz.username}" registrado. Ahora dime tu correo electr√≥nico.`;
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', `Usuario: ${comando}`);
                agregarMensajeChat('Asistente', mensaje);
                
                pasoActualRegistro = 1;
            } else {
                hablarTexto('No escuch√© bien tu nombre de usuario. Por favor, rep√≠telo con claridad.');
            }
            break;
            
        case 1: // Esperando email
            if (comando.length > 5 && (comando.includes('@') || comando.includes(' arroba '))) {
                // Convertir "arroba" a "@" si es necesario
                let emailProcesado = comando.trim().replace(/ arroba /g, '@').replace(/ punto /g, '.');
                datosRegistroVoz.email = emailProcesado;
                document.getElementById('email').value = datosRegistroVoz.email;
                
                const mensaje = `‚úÖ Email "${datosRegistroVoz.email}" registrado. Ahora dime tu nombre.`;
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', `Email: ${comando}`);
                agregarMensajeChat('Asistente', mensaje);
                
                pasoActualRegistro = 2;
            } else {
                hablarTexto('No escuch√© bien tu correo electr√≥nico. Recuerda decir "arroba" para el s√≠mbolo @ y "punto" para el punto. Por ejemplo: juan arroba ejemplo punto com');
            }
            break;
            
        case 2: // Esperando nombre
            if (comando.length > 1) {
                datosRegistroVoz.first_name = comando.trim();
                document.getElementById('first_name').value = datosRegistroVoz.first_name;
                
                const mensaje = `‚úÖ Nombre "${datosRegistroVoz.first_name}" registrado. Ahora dime tu apellido.`;
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', `Nombre: ${comando}`);
                agregarMensajeChat('Asistente', mensaje);
                
                pasoActualRegistro = 3;
            } else {
                hablarTexto('No escuch√© bien tu nombre. Por favor, rep√≠telo con claridad.');
            }
            break;
            
        case 3: // Esperando apellido
            if (comando.length > 1) {
                datosRegistroVoz.last_name = comando.trim();
                document.getElementById('last_name').value = datosRegistroVoz.last_name;
                
                const mensaje = `‚úÖ Apellido "${datosRegistroVoz.last_name}" registrado. Ahora dime tu contrase√±a. Debe tener al menos 8 caracteres.`;
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', `Apellido: ${comando}`);
                agregarMensajeChat('Asistente', mensaje);
                
                pasoActualRegistro = 4;
            } else {
                hablarTexto('No escuch√© bien tu apellido. Por favor, rep√≠telo con claridad.');
            }
            break;
            
        case 4: // Esperando contrase√±a
            if (comando.length >= 8) {
                datosRegistroVoz.password1 = comando.trim();
                document.getElementById('password1').value = datosRegistroVoz.password1;
                
                const mensaje = `‚úÖ Contrase√±a recibida. Ahora conf√≠rmala, repite tu contrase√±a nuevamente.`;
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', 'Contrase√±a: [oculta por seguridad]');
                agregarMensajeChat('Asistente', mensaje);
                
                pasoActualRegistro = 5;
            } else {
                hablarTexto('La contrase√±a debe tener al menos 8 caracteres. Por favor, rep√≠tela.');
            }
            break;
            
        case 5: // Confirmando contrase√±a
            if (comando.length >= 8) {
                datosRegistroVoz.password2 = comando.trim();
                document.getElementById('password2').value = datosRegistroVoz.password2;
                
                if (datosRegistroVoz.password1 === datosRegistroVoz.password2) {
                    // Marcar t√©rminos y condiciones
                    document.getElementById('terms').checked = true;
                    
                    const mensaje = `‚úÖ Contrase√±a confirmada correctamente. Resumen de tu registro: Usuario: ${datosRegistroVoz.username}, Email: ${datosRegistroVoz.email}, Nombre: ${datosRegistroVoz.first_name} ${datosRegistroVoz.last_name}. ¬øQuieres crear tu cuenta ahora? Di "s√≠" para confirmar o "no" para cancelar.`;
                    hablarTexto(mensaje);
                    agregarMensajeChat('Usuario', 'Contrase√±a confirmada: [oculta]');
                    agregarMensajeChat('Asistente', mensaje);
                    
                    pasoActualRegistro = 6;
                } else {
                    hablarTexto('Las contrase√±as no coinciden. Por favor, repite la confirmaci√≥n de tu contrase√±a.');
                    document.getElementById('password2').value = '';
                }
            } else {
                hablarTexto('La contrase√±a debe tener al menos 8 caracteres. Por favor, rep√≠tela.');
            }
            break;
            
        case 6: // Confirmaci√≥n final
            if (comando.includes('s√≠') || comando.includes('si') || comando.includes('confirmar') || comando.includes('aceptar')) {
                const mensaje = 'üéâ ¬°Excelente! Creando tu cuenta...';
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', 'S√≠, confirmar');
                agregarMensajeChat('Asistente', mensaje);
                
                // Detener reconocimiento de voz
                if (reconocimientoVoz && escuchandoComandos) {
                    reconocimientoVoz.stop();
                }
                
                // Enviar formulario
                setTimeout(() => {
                    document.getElementById('registerForm').submit();
                }, 1500);
                
                modoRegistroPorVoz = false;
            } else if (comando.includes('no') || comando.includes('cancelar')) {
                const mensaje = 'Registro por voz cancelado. Puedes intentarlo de nuevo cuando quieras o llenar el formulario manualmente.';
                hablarTexto(mensaje);
                agregarMensajeChat('Usuario', 'No, cancelar');
                agregarMensajeChat('Asistente', mensaje);
                
                modoRegistroPorVoz = false;
                pasoActualRegistro = 0;
                datosRegistroVoz = { username: '', email: '', first_name: '', last_name: '', password1: '', password2: '' };
                
                // Limpiar campos
                document.getElementById('username').value = '';
                document.getElementById('email').value = '';
                document.getElementById('first_name').value = '';
                document.getElementById('last_name').value = '';
                document.getElementById('password1').value = '';
                document.getElementById('password2').value = '';
                document.getElementById('terms').checked = false;
            } else {
                hablarTexto('No entend√≠ tu respuesta. Di "s√≠" para crear tu cuenta o "no" para cancelar.');
            }
            break;
    }
}

// Extraer valor de un comando de voz
function extraerValorComando(comando, palabrasClave) {
    for (const palabra of palabrasClave) {
        const indice = comando.indexOf(palabra);
        if (indice !== -1) {
            const valor = comando.substring(indice + palabra.length).trim();
            return valor;
        }
    }
    return null;
}

// Funciones del asistente
function leerCamposFormulario() {
    const mensaje = 'El formulario de registro tiene los siguientes campos: Nombre de usuario, Correo electr√≥nico, Nombre, Apellido, Contrase√±a y Confirmar contrase√±a. Puedes llenar estos campos de tres formas: 1. Manualmente con el teclado. 2. Usando comandos de voz individuales. 3. O puedes hacer el registro completo por voz presionando el bot√≥n "Registrarse por Voz" donde yo te guiar√© paso a paso, incluyendo las contrase√±as.';
    hablarTexto(mensaje);
    agregarMensajeChat('Asistente', mensaje);
}

function leerRequisitos() {
    const mensaje = 'Para registrarte necesitas: Un nombre de usuario de al menos 3 caracteres, Un correo electr√≥nico v√°lido, Tu nombre y apellido, y Una contrase√±a de al menos 8 caracteres que debes confirmar. Tambi√©n debes aceptar los t√©rminos y condiciones.';
    hablarTexto(mensaje);
    agregarMensajeChat('Asistente', mensaje);
}

function ayudaContrase√±a() {
    const mensaje = 'Para ingresar tu contrase√±a tienes dos opciones: 1. Puedes escribirla manualmente usando el teclado para mayor seguridad. 2. O puedes usar el modo de registro por voz completo, donde yo recibir√© tu contrase√±a por voz de forma guiada. Ten en cuenta que al usar voz, otras personas podr√≠an escuchar tu contrase√±a. El modo registro por voz te permite crear toda tu cuenta sin usar el teclado.';
    hablarTexto(mensaje);
    agregarMensajeChat('Asistente', mensaje);
}

function iniciarReconocimientoVoz() {
    if (reconocimientoVoz) {
        try {
            // Verificar si ya est√° escuchando
            if (escuchandoComandos) {
                hablarTexto('El reconocimiento de voz ya est√° activo');
                return;
            }
            
            reconocimientoVoz.start();
            hablarTexto('Micr√≥fono activado, puedes hablar ahora. Di comandos como: mi nombre de usuario es, mi email es, mi nombre es, mi apellido es.');
        } catch (error) {
            console.error('Error al iniciar reconocimiento:', error);
            let mensaje = 'No se pudo iniciar el reconocimiento de voz. ';
            
            if (error.name === 'InvalidStateError') {
                mensaje += 'El reconocimiento ya est√° activo.';
            } else {
                mensaje += 'Verifica que tu navegador tenga permisos de micr√≥fono.';
            }
            
            hablarTexto(mensaje);
            actualizarEstadoVoz('Error al iniciar');
        }
    } else {
        hablarTexto('El reconocimiento de voz no est√° disponible en tu navegador. Usa Chrome, Edge o Safari para esta funci√≥n.');
        actualizarEstadoVoz('No disponible');
    }
}

function activarEscuchaDirecta() {
    if (reconocimientoVoz) {
        try {
            if (escuchandoComandos) {
                hablarTexto('El reconocimiento de voz ya est√° activo');
                return;
            }
            reconocimientoVoz.start();
            hablarTexto('Micr√≥fono activado, puedes hablar ahora');
        } catch (error) {
            console.error('Error al activar escucha:', error);
            hablarTexto('No se pudo activar el micr√≥fono. Verifica los permisos.');
            actualizarEstadoVoz('Error');
        }
    }
}
}

function actualizarEstadoVoz(estado) {
    const statusElement = document.getElementById('status-texto');
    if (statusElement) {
        statusElement.textContent = estado;
    }
}

function toggleVoz() {
    vozHabilitada = !vozHabilitada;
    document.getElementById('voz-habilitada').checked = vozHabilitada;
    
    if (vozHabilitada) {
        hablarTexto('Voz activada');
    } else {
        speechSynthesis.cancel();
    }
}

// Funciones del chat
function enviarMensajeConVoz() {
    const input = document.getElementById('chat-input');
    const mensaje = input.value.trim();
    
    if (!mensaje) return;
    
    // Agregar mensaje del usuario
    agregarMensajeChat('Usuario', mensaje);
    
    // Procesar como comando de voz tambi√©n
    procesarComandoVozRegistro(mensaje.toLowerCase());
    
    // Simular respuesta del asistente si no fue procesado
    setTimeout(() => {
        const respuesta = generarRespuestaAsistenteRegistro(mensaje);
        if (respuesta) {
            agregarMensajeChat('Asistente', respuesta);
            hablarTexto(respuesta);
        }
    }, 500);
    
    input.value = '';
}

function generarRespuestaAsistenteRegistro(mensaje) {
    const mensajeLower = mensaje.toLowerCase();
    
    if (mensajeLower.includes('ayuda') || mensajeLower.includes('help')) {
        return '‚ú® Puedo ayudarte con el registro. Di comandos como: "mi nombre de usuario es...", "mi email es...", "mi nombre es...", "mi apellido es...", o preg√∫ntame sobre requisitos y contrase√±as.';
    } else if (mensajeLower.includes('hola') || mensajeLower.includes('buenos')) {
        return 'üëã ¬°Hola! Bienvenido al asistente de registro de VOCALCART. ¬øEn qu√© puedo ayudarte con tu registro?';
    } else if (mensajeLower.includes('gracias')) {
        return 'üòä ¬°De nada! Estoy aqu√≠ para ayudarte. Si necesitas algo m√°s, solo d√≠melo.';
    }
    
    return null; // Si ya se proces√≥ el comando, no duplicar respuesta
}

function agregarMensajeChat(remitente, mensaje) {
    const chatMessages = document.getElementById('chat-messages');
    const esAsistente = remitente === 'Asistente';
    
    const mensajeHTML = `
        <div class="message ${esAsistente ? 'asistente' : 'usuario'}-message mb-3">
            <div class="d-flex align-items-start">
                <div class="avatar ${esAsistente ? 'bg-primary' : 'bg-secondary'} text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-${esAsistente ? 'robot' : 'user'}" aria-hidden="true"></i>
                </div>
                <div class="message-content">
                    <strong>${remitente}:</strong>
                    <p class="mb-0">${mensaje}</p>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.innerHTML += mensajeHTML;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function limpiarChatConVoz() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = `
        <div class="message asistente-message mb-3">
            <div class="d-flex align-items-start">
                <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-robot" aria-hidden="true"></i>
                </div>
                <div class="message-content">
                    <strong>Asistente de Voz:</strong>
                    <p class="mb-2">¬°Hola! Soy tu asistente para el registro en VOCALCART. Estoy aqu√≠ para ayudarte a crear tu cuenta de forma accesible.</p>
                    <div class="small text-muted">
                        üí° <strong>Tip:</strong> Puedes usar comandos de voz o escribir. Di "ayuda" para m√°s opciones.
                    </div>
                </div>
            </div>
        </div>
    `;
    
    hablarTexto('Nueva conversaci√≥n iniciada con el asistente de registro');
}

// Funci√≥n para mantener la validaci√≥n original del formulario
function inicializarValidacionFormulario() {
    const form = document.getElementById('registerForm');
    const password1 = document.getElementById('password1');
    const password2 = document.getElementById('password2');
    const username = document.getElementById('username');
    const email = document.getElementById('email');
    const submitBtn = document.getElementById('submitBtn');
    const passwordStrength = document.getElementById('passwordStrength');
    
    // Validaci√≥n de contrase√±as en tiempo real
    function validatePasswords() {
        const pass1 = password1.value;
        const pass2 = password2.value;
        
        if (pass2 !== '' && pass1 !== pass2) {
            password2.setCustomValidity('Las contrase√±as no coinciden');
            password2.classList.add('is-invalid');
            password2.classList.remove('is-valid');
        } else if (pass2 !== '' && pass1 === pass2 && pass1.length >= 8) {
            password2.setCustomValidity('');
            password2.classList.remove('is-invalid');
            password2.classList.add('is-valid');
        } else {
            password2.classList.remove('is-invalid', 'is-valid');
        }
    }
    
    // Indicador de fuerza de contrase√±a
    function checkPasswordStrength(password) {
        let strength = 0;
        let className = '';
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        switch(strength) {
            case 0:
            case 1:
                className = 'password-weak';
                break;
            case 2:
                className = 'password-medium';
                break;
            case 3:
            case 4:
                className = 'password-strong';
                break;
            case 5:
                className = 'password-very-strong';
                break;
        }
        
        passwordStrength.className = 'password-strength ' + className;
    }
    
    // Validaci√≥n de nombre de usuario
    function validateUsername() {
        const value = username.value;
        if (value.length >= 3) {
            username.classList.remove('is-invalid');
            username.classList.add('is-valid');
        } else if (value.length > 0) {
            username.classList.add('is-invalid');
            username.classList.remove('is-valid');
        }
    }
    
    // Validaci√≥n de email
    function validateEmail() {
        const value = email.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (emailRegex.test(value)) {
            email.classList.remove('is-invalid');
            email.classList.add('is-valid');
        } else if (value.length > 0) {
            email.classList.add('is-invalid');
            email.classList.remove('is-valid');
        }
    }
    
    // Event listeners
    password1.addEventListener('input', function() {
        const value = this.value;
        checkPasswordStrength(value);
        
        if (value.length >= 8) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else if (value.length > 0) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        }
        
        validatePasswords();
    });
    
    password2.addEventListener('input', validatePasswords);
    username.addEventListener('input', validateUsername);
    email.addEventListener('input', validateEmail);
    
    // Efecto de loading al enviar el formulario
    form.addEventListener('submit', function(e) {
        const isValid = form.checkValidity();
        
        if (isValid) {
            submitBtn.classList.add('btn-loading');
            submitBtn.disabled = true;
            hablarTexto('Enviando tu registro, por favor espera');
            
            // Simular un peque√±o delay para mostrar el efecto
            setTimeout(() => {
                // El formulario se enviar√° normalmente
            }, 500);
        } else {
            hablarTexto('Por favor completa todos los campos correctamente antes de enviar el formulario');
        }
    });
    
    // Validaci√≥n del formulario completo
    form.addEventListener('input', function() {
        const inputs = form.querySelectorAll('input[required]');
        let allValid = true;
        
        inputs.forEach(input => {
            if (!input.checkValidity()) {
                allValid = false;
            }
        });
        
        if (allValid && password1.value === password2.value) {
            submitBtn.classList.add('pulse');
        } else {
            submitBtn.classList.remove('pulse');
        }
    });
    
    // Efecto de enfoque autom√°tico en el primer campo
    username.focus();
}

// CSS para indicadores de estado
const style = document.createElement('style');
style.textContent = `
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #6c757d;
        animation: pulse 1s infinite;
    }
    
    .status-indicator.active {
        background-color: #28a745;
    }
    
    .status-indicator.speaking {
        background-color: #007bff;
    }
    
    .status-indicator.error {
        background-color: #dc3545;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .voz-control-container {
        z-index: 1050;
    }
    
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0,0,0,0);
        white-space: nowrap;
        border-width: 0;
    }
`;
document.head.appendChild(style);
</script>
{% endblock contenido %}